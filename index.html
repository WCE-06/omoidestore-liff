<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>COMPASSION WORLD 入店退店管理システム</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{--bg:#0b0f1a;--card:#121a2b;--text:#e7ecff;--muted:#aab6da;--good:#1db954;--warn:#f4c542;--bad:#ff5a6a;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:18px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;background:radial-gradient(1200px 700px at 30% -10%, #1a2a6c33, transparent),radial-gradient(900px 500px at 120% 20%, #b21f1f22, transparent),var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;}
    .app{width:min(640px,100%);}
    .card{background:linear-gradient(180deg,#141d33,var(--card));border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow);border-radius:var(--radius);padding:18px;}
    .header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px;}
    .title{font-size:16px;margin:0;letter-spacing:.02em;line-height:1.35;}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);background:rgba(255,255,255,.04);white-space:nowrap;}
    .status{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);border-radius:14px;padding:12px;margin:12px 0 16px;}
    .statusRow{display:flex;align-items:flex-start;gap:10px;}
    .dot{width:10px;height:10px;border-radius:999px;margin-top:7px;background:var(--warn);box-shadow:0 0 0 4px rgba(244,197,66,.18);flex:0 0 auto;}
    .i18nBlock{line-height:1.45;}
    .i18n-ja{font-size:15px;color:var(--text);font-weight:650;}
    .i18n-sub{margin-top:6px;display:grid;gap:4px;}
    .i18n-sub div{font-size:12px;color:var(--muted);}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    button{appearance:none;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text);border-radius:16px;padding:14px 12px;cursor:pointer;transition:transform .06s ease,background .2s ease,border-color .2s ease,opacity .2s ease;user-select:none;}
    button:active{transform:translateY(1px);}
    button:disabled{opacity:.55;cursor:not-allowed;}
    .btnText{text-align:center;}
    .btnText .ja{font-size:16px;font-weight:750;}
    .btnText .sub{margin-top:6px;display:grid;gap:4px;font-size:12px;color:var(--muted);line-height:1.2;}
    .btnIn{border-color:rgba(29,185,84,.35);background:linear-gradient(180deg,rgba(29,185,84,.22),rgba(255,255,255,.06));}
    .btnOut{border-color:rgba(170,182,218,.25);background:linear-gradient(180deg,rgba(170,182,218,.14),rgba(255,255,255,.06));}
    .panel{margin-top:14px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);padding:12px;display:none;}
    .panel.show{display:block;}
    .form{margin-top:10px;display:grid;gap:10px;}
    .field{display:grid;gap:6px;}
    label{font-size:12px;color:var(--muted);}
    input,textarea{width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);color:var(--text);padding:12px 12px;font-size:14px;outline:none;}
    textarea{min-height:90px;resize:vertical;}
    .checkRow{display:flex;gap:10px;align-items:flex-start;font-size:12px;color:var(--muted);line-height:1.5;}
    .checkRow input{width:18px;height:18px;margin-top:2px;}
    .panelActions{margin-top:12px;display:grid;gap:10px;}
    .btnPrimary{border-color:rgba(29,185,84,.35);background:linear-gradient(180deg,rgba(29,185,84,.22),rgba(255,255,255,.06));}
    .btnGhost{border-color:rgba(255,255,255,.16);background:rgba(255,255,255,.05);}
    .debug{margin-top:10px;font-size:11px;color:var(--muted);opacity:.9;line-height:1.4;word-break:break-all;}
  </style>
</head>
<body>
<main class="app">
  <section class="card" aria-live="polite" aria-busy="false">
    <div class="header">
      <h1 class="title">COMPASSION WORLD 入店退店管理システム</h1>
      <div id="badge" class="badge">起動中</div>
    </div>

    <div class="status" role="status" aria-atomic="true">
      <div class="statusRow">
        <div id="dot" class="dot" aria-hidden="true"></div>
        <div class="i18nBlock">
          <div id="statusJa" class="i18n-ja">初期化中...</div>
          <div class="i18n-sub">
            <div id="statusEn">Initializing...</div>
            <div id="statusZh">正在初始化...</div>
            <div id="statusKo">초기화 중...</div>
          </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button id="btnIn" class="btnIn" disabled>
        <div class="btnText">
          <div class="ja">入店</div>
          <div class="sub"><div>Check in</div><div>进入</div><div>입장</div></div>
        </div>
      </button>
      <button id="btnOut" class="btnOut" disabled>
        <div class="btnText">
          <div class="ja">退店</div>
          <div class="sub"><div>Check out</div><div>离开</div><div>퇴장</div></div>
        </div>
      </button>
    </div>

    <div id="regPanel" class="panel" aria-live="polite">
      <div class="i18nBlock">
        <div class="i18n-ja">初回のみ、会員情報（氏名 住所 電話番号）の登録が必要です。</div>
        <div class="i18n-sub">
          <div>One-time registration is required (Name, Address, Phone).</div>
          <div>首次需要登记（姓名 住址 电话）。</div>
          <div>최초 1회 등록이 필요합니다 (이름 주소 전화).</div>
        </div>
      </div>

      <div class="form">
        <div class="field">
          <label>氏名（フルネーム）</label>
          <input id="f_name" type="text" placeholder="例 山田 太郎" autocomplete="name" />
        </div>
        <div class="field">
          <label>電話番号</label>
          <input id="f_phone" type="tel" placeholder="例 09012345678" autocomplete="tel" />
        </div>
        <div class="field">
          <label>住所</label>
          <textarea id="f_addr" placeholder="例 山梨県北杜市..."></textarea>
        </div>
        <div class="checkRow">
          <input id="f_consent" type="checkbox" />
          <div>
            同意します（未精算や緊急時のご連絡、防犯上の確認のために利用します）
            <div class="i18n-sub" style="margin-top:6px;">
              <div>I agree (Used for contact in case of unpaid checkout or emergencies, and for security confirmation)</div>
              <div>我同意（用于未结账或紧急情况联系及安全确认）</div>
              <div>동의합니다 (미정산/긴급 연락 및 보안 확인 목적)</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panelActions">
        <button id="btnRegSubmit" class="btnPrimary" disabled>登録を送信</button>
        <button id="btnRegLater" class="btnGhost">閉じる</button>
      </div>
    </div>

    <div id="debug" class="debug"></div>
  </section>
</main>

<script>
  const LIFF_ID = "2008818718-xTQWF4uO";

  const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbyPUuou2-AYoL689TwmcoQtCiSkS2HcDK-XsE9mFumOby2BYVOD1CAV8b4S6fc_-zMS/exec";

  function setDot(state){
    const el = document.getElementById("dot");
    if (state==="ok"){ el.style.background="var(--good)"; el.style.boxShadow="0 0 0 4px rgba(29,185,84,.18)"; return; }
    if (state==="busy"){ el.style.background="var(--warn)"; el.style.boxShadow="0 0 0 4px rgba(244,197,66,.18)"; return; }
    el.style.background="var(--bad)"; el.style.boxShadow="0 0 0 4px rgba(255,90,106,.18)";
  }
  function setStatusLines(ja,en,zh,ko){
    document.getElementById("statusJa").textContent = ja || "";
    document.getElementById("statusEn").textContent = en || "";
    document.getElementById("statusZh").textContent = zh || "";
    document.getElementById("statusKo").textContent = ko || "";
  }
  function setBadge(t){ document.getElementById("badge").textContent = t; }
  function setBusy(on){
    document.querySelector(".card").setAttribute("aria-busy", on ? "true" : "false");
    document.getElementById("btnIn").disabled = on;
    document.getElementById("btnOut").disabled = on;
  }
  function showRegPanel(show){
    document.getElementById("regPanel").classList.toggle("show", !!show);
  }
  function setDebug(t){ document.getElementById("debug").textContent = t || ""; }

  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      window[cb] = (data) => { cleanup(); resolve(data); };
      const script = document.createElement("script");
      const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, 20000);
      function cleanup(){
        clearTimeout(timer);
        if (script.parentNode) script.parentNode.removeChild(script);
        delete window[cb];
      }
      const sep = url.includes("?") ? "&" : "?";
      script.src = url + sep + "callback=" + encodeURIComponent(cb);
      script.onerror = () => { cleanup(); reject(new Error("loaderror")); };
      document.body.appendChild(script);
    });
  }

  function updateRegButton(){
    const fullName = document.getElementById("f_name").value.trim();
    const phone = document.getElementById("f_phone").value.trim();
    const address = document.getElementById("f_addr").value.trim();
    const consent = document.getElementById("f_consent").checked;
    document.getElementById("btnRegSubmit").disabled = !(fullName && phone && address && consent);
  }

  async function profileStatus(){
    const idToken = liff.getIDToken();
    if (!idToken) return { ok:false, code:"NO_IDTOKEN" };
    const url = GAS_EXEC_URL + "?action=profile_status&id_token=" + encodeURIComponent(idToken) + "&t=" + Date.now();
    return await jsonp(url);
  }

  async function gate(){
    document.getElementById("btnIn").disabled = true;
    document.getElementById("btnOut").disabled = true;

    const idToken = liff.getIDToken();
    setDebug("debug: idToken=" + (idToken ? "ok" : "null"));
    if (!idToken){
      setDot("error");
      setBadge("エラー");
      setStatusLines(
        "送信できません。LIFFのopenid設定と権限許可が必要です。",
        "openid scope/permission is required.",
        "需要openid权限。",
        "openid 권한이 필요합니다."
      );
      showRegPanel(true);
      return;
    }

    const st = await profileStatus();
    if (st && st.ok && st.has_profile){
      setDot("ok");
      setBadge("準備OK");
      setStatusLines(
        "準備ができました。入店または退店を押してください。",
        "Ready. Tap Check in or Check out.",
        "准备就绪。请选择进入或离开。",
        "준비 완료. 입장 또는 퇴장을 눌러 주세요."
      );
      showRegPanel(false);
      document.getElementById("btnIn").disabled = false;
      document.getElementById("btnOut").disabled = false;
      return;
    }

    setDot("busy");
    setBadge("準備OK");
    setStatusLines(
      "初回のみ、会員情報（氏名 住所 電話番号）の登録が必要です。",
      "Registration required.",
      "需要登记。",
      "등록 필요."
    );
    showRegPanel(true);
  }

  async function sendProfile(){
    const fullName = document.getElementById("f_name").value.trim();
    const phone = document.getElementById("f_phone").value.trim();
    const address = document.getElementById("f_addr").value.trim();
    const consent = document.getElementById("f_consent").checked;

    const idToken = liff.getIDToken();
    if (!idToken){
      setDot("error");
      setBadge("エラー");
      setStatusLines(
        "送信できません。LIFFのopenid設定と権限許可が必要です。",
        "openid scope/permission is required.",
        "需要openid权限。",
        "openid 권한이 필요합니다."
      );
      return;
    }

    setBusy(true);
    setDot("busy");
    setBadge("送信中");
    setStatusLines("送信中です...", "Sending...", "发送中...", "전송 중...");

    try{
      const url = GAS_EXEC_URL
        + "?action=profile_set"
        + "&id_token=" + encodeURIComponent(idToken)
        + "&full_name=" + encodeURIComponent(fullName)
        + "&phone=" + encodeURIComponent(phone)
        + "&address=" + encodeURIComponent(address)
        + "&consent=" + encodeURIComponent(String(consent))
        + "&t=" + Date.now();

      const res = await jsonp(url);
      if (res && res.ok){
        setDot("ok");
        setBadge("完了");
        setStatusLines(
          "登録が完了しました。入店または退店を押してください。",
          "Registration completed.",
          "登记完成。",
          "등록 완료."
        );
        await gate();
      } else {
        setDot("error");
        setBadge("エラー");
        const msg = (res && res.message) ? res.message : "登録に失敗しました。";
        setStatusLines(msg, "Registration failed.", "登记失败。", "등록 실패.");
      }
    } catch(e){
      setDot("error");
      setBadge("エラー");
      setStatusLines(
        "通信エラーまたはタイムアウトです。",
        "Network error or timeout.",
        "通信错误或超时。",
        "통신 오류 또는 시간 초과."
      );
    } finally {
      setBusy(false);
    }
  }

  async function callAction(action){
    const idToken = liff.getIDToken();
    if (!idToken){
      await gate();
      return;
    }
    setBusy(true);
    setDot("busy");
    setBadge("処理中");
    setStatusLines("通信中です...", "Communicating...", "通信中...", "통신 중...");
    try{
      const url = GAS_EXEC_URL + "?action=" + encodeURIComponent(action) + "&id_token=" + encodeURIComponent(idToken) + "&t=" + Date.now();
      const res = await jsonp(url);
      if (res && res.ok){
        setDot("ok");
        setBadge("完了");
        setStatusLines(
          res.message || "完了しました。",
          "Done.",
          "完成。",
          "완료."
        );
      } else if (res && res.code === "DENY_NEED_PROFILE"){
        await gate();
      } else {
        setDot("error");
        setBadge("エラー");
        const msg = (res && res.message) ? res.message : "エラーが発生しました。";
        setStatusLines(msg, "Error.", "错误。", "오류.");
      }
    } catch(e){
      setDot("error");
      setBadge("エラー");
      setStatusLines(
        "通信エラーまたはタイムアウトです。",
        "Network error or timeout.",
        "通信错误或超时。",
        "통신 오류 또는 시간 초과."
      );
    } finally {
      setBusy(false);
    }
  }

  document.getElementById("btnIn").addEventListener("click", () => callAction("in"));
  document.getElementById("btnOut").addEventListener("click", () => callAction("out"));
  document.getElementById("btnRegSubmit").addEventListener("click", sendProfile);
  document.getElementById("btnRegLater").addEventListener("click", () => {
    setDot("error");
    setBadge("未登録");
    setStatusLines(
      "会員情報の登録が完了していないため、入店退店はできません。",
      "You can't proceed without registration.",
      "未完成登记，无法继续。",
      "등록이 완료되지 않아 진행할 수 없습니다."
    );
  });

  ["f_name","f_phone","f_addr","f_consent"].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener("input", updateRegButton);
    el.addEventListener("change", updateRegButton);
  });
  updateRegButton();

  async function init(){
    setBadge("起動中");
    setDot("busy");
    setStatusLines("初期化中...", "Initializing...", "正在初始化...", "초기화 중...");
    try{
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
      await gate();
    }catch(e){
      setDot("error");
      setBadge("エラー");
      setStatusLines(
        "初期化に失敗しました。設定と通信環境を確認してください。",
        "Initialization failed.",
        "初始化失败。",
        "초기화 실패."
      );
    }
  }

  init();
</script>
</body>
</html>
