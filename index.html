<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>COMPASSION WORLD 入店退店管理システム</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#0b0f1a;
      --card:#121a2b;
      --card2:#141d33;
      --text:#e7ecff;
      --muted:#aab6da;
      --good:#1db954;
      --warn:#f4c542;
      --bad:#ff5a6a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --focus: rgba(244,197,66,.30);
      --ring: rgba(255,90,106,.35);
      --okring: rgba(29,185,84,.25);
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 30% -10%, #1a2a6c33, transparent),
        radial-gradient(900px 500px at 120% 20%, #b21f1f22, transparent),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }

    .app{ width:min(720px, 100%); }

    .card{
      background: linear-gradient(180deg, #141d33, var(--card));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 18px;
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    .title{
      font-size:16px;
      margin:0;
      letter-spacing:.02em;
      line-height:1.35;
    }

    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }

    .status{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      padding:12px;
      margin:12px 0 16px;
    }

    .statusRow{
      display:flex;
      align-items:flex-start;
      gap:10px;
    }

    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      margin-top:7px;
      background:var(--warn);
      box-shadow:0 0 0 4px rgba(244,197,66,.18);
      flex:0 0 auto;
    }

    .i18nBlock{ line-height:1.45; }
    .i18n-ja{ font-size:15px; color:var(--text); font-weight:650; }
    .i18n-sub{ margin-top:6px; display:grid; gap:4px; }
    .i18n-sub div{ font-size:12px; color:var(--muted); }

    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }

    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:16px;
      padding:14px 12px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      user-select:none;
    }

    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnText{ text-align:center; }
    .btnText .ja{ font-size:16px; font-weight:750; }
    .btnText .sub{
      margin-top:6px;
      display:grid;
      gap:4px;
      font-size:12px;
      color:var(--muted);
      line-height:1.2;
    }

    .btnIn{
      border-color: rgba(29,185,84,.35);
      background: linear-gradient(180deg, rgba(29,185,84,.22), rgba(255,255,255,.06));
    }
    .btnOut{
      border-color: rgba(170,182,218,.25);
      background: linear-gradient(180deg, rgba(170,182,218,.14), rgba(255,255,255,.06));
    }

    .footerNote{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
    }

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(640px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(20,29,51,.95), rgba(18,26,43,.95));
      box-shadow: var(--shadow);
      padding:16px;
    }

    .modalTop{
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .modalTitle{ margin:0; font-size:15px; }
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .modalBody{ margin-top:10px; }

    .modalActions{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:14px;
    }

    .btnPrimary{
      border-color: rgba(29,185,84,.35);
      background: linear-gradient(180deg, rgba(29,185,84,.22), rgba(255,255,255,.06));
    }

    .btnGhost{
      border-color: rgba(255,255,255,.16);
      background: rgba(255,255,255,.05);
    }

    .btnDanger{
      border-color: rgba(255,90,106,.35);
      background: linear-gradient(180deg, rgba(255,90,106,.18), rgba(255,255,255,.06));
    }

    .form{
      margin-top:12px;
      display:grid;
      gap:10px;
    }

    .hintBox{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      line-height:1.6;
      font-size:13px;
    }

    .field{
      display:grid;
      gap:6px;
    }

    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    label{ font-size:12px; color:var(--muted); }

    input, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:12px 12px;
      font-size:14px;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus, textarea:focus{
      border-color: rgba(244,197,66,.45);
      box-shadow: 0 0 0 4px var(--focus);
    }
    textarea{ min-height: 90px; resize: vertical; }

    .checkRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .checkRow input{
      width:18px;
      height:18px;
      margin-top:2px;
      accent-color: var(--good);
    }

    .errField input, .errField textarea{
      border-color: rgba(255,90,106,.55);
      box-shadow: 0 0 0 4px rgba(255,90,106,.14);
    }
    .errCheck{
      border-color: rgba(255,90,106,.45);
      box-shadow: 0 0 0 4px rgba(255,90,106,.12);
    }

    .termLinkRow{
      margin-top:8px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .linkBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      text-decoration:none;
    }

    .srOnly{
      position:absolute; width:1px; height:1px;
      padding:0; margin:-1px; overflow:hidden;
      clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 12px 0;
      border:0;
    }

    .termsBox{
      max-height: 44vh;
      overflow:auto;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      color: var(--muted);
      line-height:1.65;
      font-size:12px;
      white-space:pre-wrap;
    }

    .smallNote{
      margin-top:10px;
      font-size:12px;
      color: var(--muted);
      line-height:1.55;
    }
  </style>
</head>

<body>
  <main class="app">
    <section class="card" aria-live="polite" aria-busy="false">
      <div class="header">
        <h1 class="title">COMPASSION WORLD 入店退店管理システム</h1>
        <div id="badge" class="badge">起動中</div>
      </div>

      <div class="status" role="status" aria-atomic="true">
        <div class="statusRow">
          <div id="dot" class="dot" aria-hidden="true"></div>
          <div class="i18nBlock">
            <div id="statusJa" class="i18n-ja">初期化中...</div>
            <div class="i18n-sub">
              <div id="statusEn">Initializing...</div>
              <div id="statusZh">正在初始化...</div>
              <div id="statusKo">초기화 중...</div>
            </div>
          </div>
        </div>
      </div>

      <div id="actionsWrap" class="actions">
        <button id="btnIn" class="btnIn" disabled>
          <div class="btnText">
            <div class="ja">入店</div>
            <div class="sub">
              <div>Check in</div>
              <div>进入</div>
              <div>입장</div>
            </div>
          </div>
        </button>

        <button id="btnOut" class="btnOut" disabled>
          <div class="btnText">
            <div class="ja">退店</div>
            <div class="sub">
              <div>Check out</div>
              <div>离开</div>
              <div>퇴장</div>
            </div>
          </div>
        </button>
      </div>

      <div id="footerWrap" class="footerNote">
        処理中はボタンが押せません。画面の案内に沿って操作してください。
        <div class="i18n-sub" style="margin-top:8px;">
          <div>Buttons are disabled during processing. Please follow the on-screen instructions.</div>
          <div>处理过程中按钮不可用。请按照屏幕提示操作。</div>
          <div>처리 중에는 버튼을 사용할 수 없습니다. 화면 안내에 따라 주세요.</div>
        </div>
      </div>
    </section>
  </main>

  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalTop">
        <h2 id="modalTitle" class="modalTitle">確認</h2>
        <div id="modalPill" class="pill">案内</div>
      </div>

      <div class="modalBody">
        <div class="i18nBlock">
          <div id="modalJa" class="i18n-ja">確認中...</div>
          <div class="i18n-sub">
            <div id="modalEn">Checking...</div>
            <div id="modalZh">正在确认...</div>
            <div id="modalKo">확인 중...</div>
          </div>
        </div>

        <div id="modalForm" style="display:none;"></div>

        <div id="modalActions" class="modalActions">
          <button id="btnModalPrimary" class="btnPrimary" disabled>...</button>
          <button id="btnModalSecondary" class="btnGhost" disabled>...</button>
        </div>

        <div class="srOnly" id="srLive" aria-live="assertive"></div>
      </div>
    </div>
  </div>

<script>
  const LIFF_ID = "2008818718-xTQWF4uO";

  const GAS_EXEC_URL =
    "https://script.google.com/macros/s/AKfycbzieYyWk17GUCQnkFU8fZT5N2shkyswLoj9r7Z72XNIstCEBRx4NwjciRs6Sj-YcAJ1r/exec";

  const OA_ID_WITH_AT = "@420taqgx";
  const OA_ADD_FRIEND_URL = "https://line.me/R/ti/p/" + encodeURIComponent(OA_ID_WITH_AT);

  const STORE = {
    lat: 35.9025210,
    lon: 138.4435135,
    radiusM: 50
  };

  const TERMS = {
    version: "2026-01-11",
    text:
`COMPASSION WORLDが
平和で心地よい世界であり続けるために

COMPASSION WORLDは、
訪れるすべての方が安心して過ごせる
平和であたたかな世界であることを大切にしています。
その世界を守り続けるため、
初めてご利用いただく際のみ、
会員登録へのご協力をお願いしています。
ご登録後は、入店・退店の操作のみで
スムーズにご利用いただけます。

1. 登録情報について
初回登録では、姓・名、姓カナ・名カナ、電話番号、住所の入力が必要です。
未精算時や緊急時のご連絡、防犯上の確認のために利用します。

2. 施設内の備品等の取扱い
施設内の備品、設備、商品、什器等に破損・汚損・紛失等が生じた場合、
故意・過失の有無にかかわらず、当施設が算定する実費相当額を全額ご負担いただきます。

3. 利用停止
不正行為や安全確保上の必要がある場合、利用を停止することがあります。

4. 免責
通信障害、端末の状態、各サービスの仕様変更等により、本システムが利用できない場合があります。

本システムが、
COMPASSION WORLDの平和な世界を守るために
利用されることに同意します
`
  };

  const I18N = {
    init: ["初期化中...","Initializing...","正在初始化...","초기화 중..."],
    ready: [
      "準備ができました。入店または退店を押してください。",
      "Ready. Tap Check in or Check out.",
      "准备就绪。请选择进入或离开。",
      "준비 완료. 입장 또는 퇴장을 눌러 주세요."
    ],
    initFail: [
      "初期化に失敗しました。通信環境と設定を確認してください。",
      "Initialization failed. Check network and settings.",
      "初始化失败。请检查网络和设置。",
      "초기화에 실패했습니다. 네트워크와 설정을 확인해 주세요."
    ],
    tokenMissing: [
      "認証情報を取得できませんでした。LINEを開き直してお試しください。",
      "Could not get authentication info. Please reopen LINE and try again.",
      "无法获取认证信息。请重新打开LINE后重试。",
      "인증 정보를 가져올 수 없습니다. LINE을 다시 열고 시도해 주세요."
    ],
    netErr: [
      "通信エラーまたはタイムアウトです。電波状況を確認してお試しください。",
      "Network error or timeout. Check your connection.",
      "通信错误或超时。请检查网络。",
      "통신 오류 또는 시간 초과. 네트워크를 확인해 주세요."
    ],
    geoNeed: [
      "現地での操作を確認できませんでした。位置情報の許可をオンにして、もう一度お試しください。",
      "Could not verify on-site. Enable location permission and try again.",
      "无法确认您在现场。请开启定位权限后重试。",
      "현장 확인이 되지 않습니다. 위치 권한을 켠 뒤 다시 시도해 주세요."
    ],
    geoFar: (m) => ([
      "現地からの操作のみ受け付けています。いまの距離は約 " + m + "m です。",
      "Only on-site operation is allowed. Distance: about " + m + "m.",
      "仅允许在现场操作。当前距离约 " + m + " 米。",
      "현장 조작만 가능합니다. 현재 거리 약 " + m + "m 입니다."
    ]),
    confirmIn: {
      title: "確認", pill: "入店",
      body: ["入店を記録します。よろしいですか。","You are about to check in. Continue?","将记录进入。继续吗？","입장을 기록합니다. 진행할까요?"],
      primary: "入店する", secondary: "やめる"
    },
    confirmOut: {
      title: "確認", pill: "退店",
      body: ["退店を記録します。よろしいですか。","You are about to check out. Continue?","将记录离开。继续吗？","퇴장을 기록합니다. 진행할까요?"],
      primary: "退店する", secondary: "やめる"
    },
    friendGate: {
      title: "友だち追加", pill: "初回のみ",
      body: ["ご利用には公式LINEの友だち追加が必要です。下のボタンから追加してください。","To continue, please add our official LINE account using the button below.","继续使用前，请先通过下方按钮添加我们的官方LINE账号。","계속하려면 아래 버튼으로 공식 LINE 계정을 추가해 주세요."],
      primary: "友だち追加を開く", secondary: "追加できたら再チェック"
    },
    profileGate: {
      title: "会員情報の登録", pill: "初回のみ",
      body: ["初めてご利用いただく際のみ、会員登録へのご協力をお願いしています。","One-time registration is required on your first visit.","首次使用时需要进行一次登记。","최초 1회 등록이 필요합니다."],
      primary: "登録する", secondary: "あとで"
    },
    termsGate: {
      title: "利用規約", pill: "確認",
      body: ["規約を確認し、同意にチェックしてください。","Please read the terms and check your agreement.","请阅读条款并勾选同意。","약관을 확인한 뒤 동의에 체크해 주세요."],
      primary: "規約を開く", secondary: "閉じる"
    }
  };

  const elBadge = document.getElementById("badge");
  const elDot = document.getElementById("dot");
  const elStatusJa = document.getElementById("statusJa");
  const elStatusEn = document.getElementById("statusEn");
  const elStatusZh = document.getElementById("statusZh");
  const elStatusKo = document.getElementById("statusKo");
  const btnIn = document.getElementById("btnIn");
  const btnOut = document.getElementById("btnOut");
  const card = document.querySelector(".card");
  const actionsWrap = document.getElementById("actionsWrap");
  const footerWrap = document.getElementById("footerWrap");

  const overlay = document.getElementById("overlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalPill = document.getElementById("modalPill");
  const modalJa = document.getElementById("modalJa");
  const modalEn = document.getElementById("modalEn");
  const modalZh = document.getElementById("modalZh");
  const modalKo = document.getElementById("modalKo");
  const modalForm = document.getElementById("modalForm");
  const btnModalPrimary = document.getElementById("btnModalPrimary");
  const btnModalSecondary = document.getElementById("btnModalSecondary");
  const srLive = document.getElementById("srLive");

  let friendPollTimer = null;
  let lastGeoOkAt = 0;
  let lastGeoDistM = null;

  function setDot(state){
    if (state === "ok") { elDot.style.background = "var(--good)"; elDot.style.boxShadow = "0 0 0 4px rgba(29,185,84,.18)"; return; }
    if (state === "busy") { elDot.style.background = "var(--warn)"; elDot.style.boxShadow = "0 0 0 4px rgba(244,197,66,.18)"; return; }
    if (state === "error") { elDot.style.background = "var(--bad)"; elDot.style.boxShadow = "0 0 0 4px rgba(255,90,106,.18)"; return; }
    elDot.style.background = "var(--warn)";
    elDot.style.boxShadow = "0 0 0 4px rgba(244,197,66,.18)";
  }

  function setStatusLines(lines){
    elStatusJa.textContent = lines[0] || "";
    elStatusEn.textContent = lines[1] || "";
    elStatusZh.textContent = lines[2] || "";
    elStatusKo.textContent = lines[3] || "";
    srLive.textContent = lines[0] || "";
  }

  function enableButtons(ready){
    btnIn.disabled = !ready;
    btnOut.disabled = !ready;
  }

  function showOverlay(show){
    overlay.classList.toggle("show", !!show);
    overlay.setAttribute("aria-hidden", show ? "false" : "true");
  }

  function setBusy(on){
    card.setAttribute("aria-busy", on ? "true" : "false");
    enableButtons(!on);
  }

  function setModal(cfg){
    modalTitle.textContent = cfg.title || "";
    modalPill.textContent = cfg.pill || "";
    modalJa.textContent = (cfg.body && cfg.body[0]) || "";
    modalEn.textContent = (cfg.body && cfg.body[1]) || "";
    modalZh.textContent = (cfg.body && cfg.body[2]) || "";
    modalKo.textContent = (cfg.body && cfg.body[3]) || "";
    srLive.textContent = (cfg.body && cfg.body[0]) || "";
    modalForm.style.display = "none";
    modalForm.innerHTML = "";
    btnModalPrimary.textContent = cfg.primary || "";
    btnModalSecondary.textContent = cfg.secondary || "";
    btnModalPrimary.disabled = false;
    btnModalSecondary.disabled = false;
  }

  function hideActionsForRegistration(){
    actionsWrap.style.display = "none";
    footerWrap.style.display = "none";
    enableButtons(false);
  }

  function showActions(){
    actionsWrap.style.display = "";
    footerWrap.style.display = "";
  }

  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      window[cb] = (data) => { cleanup(); resolve(data); };

      const script = document.createElement("script");
      const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, 20000);

      function cleanup() {
        clearTimeout(timer);
        if (script.parentNode) script.parentNode.removeChild(script);
        delete window[cb];
      }

      const sep = url.includes("?") ? "&" : "?";
      script.src = url + sep + "callback=" + encodeURIComponent(cb);
      script.onerror = () => { cleanup(); reject(new Error("load error")); };

      document.body.appendChild(script);
    });
  }

  async function checkFriendshipOnce(){
    try{
      const r = await liff.getFriendship();
      return !!(r && r.friendFlag);
    } catch(e){
      return null;
    }
  }

  async function checkProfileStatus(){
    const idToken = liff.getIDToken();
    if (!idToken) return { ok:false };
    const url = GAS_EXEC_URL + "?action=profile_status&id_token=" + encodeURIComponent(idToken) + "&t=" + Date.now();
    return await jsonp(url);
  }

  function startFriendPoll(){
    if (friendPollTimer) clearInterval(friendPollTimer);
    friendPollTimer = setInterval(async () => {
      const friend = await checkFriendshipOnce();
      if (friend === true) {
        clearInterval(friendPollTimer);
        friendPollTimer = null;
        await gateFlow();
      }
    }, 1500);
  }

  function toRad(d){ return d * Math.PI / 180; }

  function haversineM(lat1, lon1, lat2, lon2){
    const R = 6371e3;
    const p1 = toRad(lat1);
    const p2 = toRad(lat2);
    const dp = toRad(lat2 - lat1);
    const dl = toRad(lon2 - lon1);
    const a = Math.sin(dp/2) * Math.sin(dp/2) +
              Math.cos(p1) * Math.cos(p2) *
              Math.sin(dl/2) * Math.sin(dl/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function getGeoOnce(){
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("no geolocation"));
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve(pos),
        (err) => reject(err),
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 5000 }
      );
    });
  }

  async function verifyOnSite(){
    try{
      const pos = await getGeoOnce();
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const dist = haversineM(lat, lon, STORE.lat, STORE.lon);
      lastGeoDistM = dist;
      if (dist <= STORE.radiusM) {
        lastGeoOkAt = Date.now();
        return { ok:true, distM: dist };
      }
      return { ok:false, distM: dist };
    } catch(e){
      return { ok:false, distM: null, err: e };
    }
  }

  function withinRecentGeoOk(){
    return (Date.now() - lastGeoOkAt) <= 120000;
  }

  async function gateFlow(){
    enableButtons(false);

    setBusy(true);
    elBadge.textContent = "確認中";
    setDot("busy");
    setStatusLines(["確認中...", "Checking...", "正在确认...", "확인 중..."]);

    const geo = await verifyOnSite();
    if (!geo.ok) {
      setBusy(false);
      elBadge.textContent = "現地確認";
      setDot("error");
      if (geo.distM == null) {
        setStatusLines(I18N.geoNeed);
      } else {
        setStatusLines(I18N.geoFar(Math.round(geo.distM)));
      }
      showOverlay(false);
      return;
    }

    const friend = await checkFriendshipOnce();
    if (friend !== true) {
      setBusy(false);
      showOverlay(true);
      setModal(I18N.friendGate);
      btnModalPrimary.onclick = async () => {
        try{ await liff.openWindow({ url: OA_ADD_FRIEND_URL, external: true }); }
        catch(e){ window.open(OA_ADD_FRIEND_URL, "_blank"); }
        startFriendPoll();
      };
      btnModalSecondary.onclick = async () => { await gateFlow(); };
      startFriendPoll();
      return;
    }

    const prof = await checkProfileStatus();
    if (!(prof && prof.ok && prof.has_profile)) {
      setBusy(false);
      showOverlay(true);
      renderProfileForm();
      return;
    }

    showOverlay(false);
    showActions();
    elBadge.textContent = "準備OK";
    setBusy(false);
    setDot("ok");
    setStatusLines(I18N.ready);
    enableButtons(true);
  }

  function renderTermsModal(){
    showOverlay(true);
    modalTitle.textContent = "利用規約";
    modalPill.textContent = "確認";
    modalJa.textContent = "規約を確認してください。";
    modalEn.textContent = "Please read the terms.";
    modalZh.textContent = "请阅读条款。";
    modalKo.textContent = "약관을 확인해 주세요.";

    modalForm.style.display = "block";
    modalForm.innerHTML = `
      <div class="termsBox" id="termsBox">${escapeHtml_(TERMS.text)}</div>
      <div class="smallNote">
        版: ${escapeHtml_(TERMS.version)}
      </div>
    `;

    btnModalPrimary.textContent = "閉じる";
    btnModalSecondary.textContent = "閉じる";
    btnModalPrimary.disabled = false;
    btnModalSecondary.disabled = false;
    btnModalPrimary.onclick = () => showOverlay(false);
    btnModalSecondary.onclick = () => showOverlay(false);
  }

  function escapeHtml_(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;")
      .replaceAll("\n","<br/>");
  }

  function renderProfileForm(){
    hideActionsForRegistration();

    modalTitle.textContent = "会員情報の登録";
    modalPill.textContent = "初回のみ";
    modalJa.textContent = I18N.profileGate.body[0];
    modalEn.textContent = I18N.profileGate.body[1];
    modalZh.textContent = I18N.profileGate.body[2];
    modalKo.textContent = I18N.profileGate.body[3];

    btnModalPrimary.textContent = "登録を送信";
    btnModalSecondary.textContent = "閉じる";
    btnModalPrimary.disabled = false;
    btnModalSecondary.disabled = false;

    modalForm.style.display = "block";
    modalForm.innerHTML = `
      <div class="hintBox">
        COMPASSION WORLDが<br>
        平和で心地よい世界であり続けるために<br><br>
        COMPASSION WORLDは、訪れるすべての方が安心して過ごせる平和であたたかな世界であることを大切にしています。<br>
        その世界を守り続けるため、初めてご利用いただく際のみ、会員登録へのご協力をお願いしています。<br>
        ご登録後は、入店・退店の操作のみでスムーズにご利用いただけます。
      </div>

      <hr class="divider"/>

      <div class="form">
        <div class="row2">
          <div class="field" id="wrap_sei">
            <label>姓</label>
            <input id="f_sei" type="text" placeholder="例 山田" autocomplete="family-name" />
          </div>
          <div class="field" id="wrap_mei">
            <label>名</label>
            <input id="f_mei" type="text" placeholder="例 太郎" autocomplete="given-name" />
          </div>
        </div>

        <div class="row2">
          <div class="field" id="wrap_sei_kana">
            <label>姓（カナ）</label>
            <input id="f_sei_kana" type="text" placeholder="例 ヤマダ" inputmode="kana" />
          </div>
          <div class="field" id="wrap_mei_kana">
            <label>名（カナ）</label>
            <input id="f_mei_kana" type="text" placeholder="例 タロウ" inputmode="kana" />
          </div>
        </div>

        <div class="field" id="wrap_phone">
          <label>電話番号</label>
          <input id="f_phone" type="tel" placeholder="例 09012345678" autocomplete="tel" />
        </div>

        <div class="field" id="wrap_addr">
          <label>住所</label>
          <textarea id="f_addr" placeholder="例 山梨県北杜市..."></textarea>
        </div>

        <div class="termLinkRow">
          <a class="linkBtn" href="javascript:void(0)" id="btnOpenTerms">利用規約を開く</a>
          <span class="smallNote">版: ${escapeHtml_(TERMS.version)}</span>
        </div>

        <div class="checkRow" id="wrap_consent">
          <input id="f_consent" type="checkbox" />
          <div>
            本システムが、COMPASSION WORLDの平和な世界を守るために利用されることに同意します
            <div class="i18n-sub" style="margin-top:6px;">
              <div>I agree that this system is used to keep COMPASSION WORLD peaceful and comfortable.</div>
              <div>我同意本系统用于守护COMPASSION WORLD的和平与舒适。</div>
              <div>본 시스템이 COMPASSION WORLD의 평화롭고 편안한 환경을 지키기 위해 사용되는 것에 동의합니다.</div>
            </div>
          </div>
        </div>

        <div class="smallNote">
          同意チェックの前に、一度は利用規約を開いて確認してください。
        </div>
      </div>
    `;

    const btnOpenTerms = document.getElementById("btnOpenTerms");
    btnOpenTerms.onclick = () => renderTermsModal();

    let termsOpenedOnce = false;
    btnOpenTerms.addEventListener("click", () => { termsOpenedOnce = true; });

    btnModalPrimary.onclick = async () => {
      window.scrollTo({ top: 0, behavior: "smooth" });

      const sei = document.getElementById("f_sei").value.trim();
      const mei = document.getElementById("f_mei").value.trim();
      const seiKana = document.getElementById("f_sei_kana").value.trim();
      const meiKana = document.getElementById("f_mei_kana").value.trim();
      const phone = document.getElementById("f_phone").value.trim();
      const address = document.getElementById("f_addr").value.trim();
      const consent = document.getElementById("f_consent").checked;

      clearErrors_();

      const missing = [];
      if (!sei) missing.push("sei");
      if (!mei) missing.push("mei");
      if (!seiKana) missing.push("sei_kana");
      if (!meiKana) missing.push("mei_kana");
      if (!phone) missing.push("phone");
      if (!address) missing.push("address");
      if (!consent) missing.push("consent");
      if (!termsOpenedOnce) missing.push("terms_opened");

      if (missing.length) {
        markErrors_(missing);
        setDot("error");
        setStatusLines([
          "未入力の項目があります。該当箇所を確認してください。",
          "Some fields are missing. Please check highlighted items.",
          "有未填写项目。请确认标记位置。",
          "미입력 항목이 있습니다. 표시된 항목을 확인해 주세요."
        ]);
        return;
      }

      if (!withinRecentGeoOk()) {
        const geo = await verifyOnSite();
        if (!geo.ok) {
          setDot("error");
          if (geo.distM == null) setStatusLines(I18N.geoNeed);
          else setStatusLines(I18N.geoFar(Math.round(geo.distM)));
          return;
        }
      }

      const idToken = liff.getIDToken();
      if (!idToken) {
        setDot("error");
        setStatusLines(I18N.tokenMissing);
        return;
      }

      setBusy(true);
      elBadge.textContent = "送信中";
      setDot("busy");

      try{
        const url =
          GAS_EXEC_URL +
          "?action=profile_set" +
          "&id_token=" + encodeURIComponent(idToken) +
          "&sei=" + encodeURIComponent(sei) +
          "&mei=" + encodeURIComponent(mei) +
          "&sei_kana=" + encodeURIComponent(seiKana) +
          "&mei_kana=" + encodeURIComponent(meiKana) +
          "&phone=" + encodeURIComponent(phone) +
          "&address=" + encodeURIComponent(address) +
          "&consent=" + encodeURIComponent(String(consent)) +
          "&terms_version=" + encodeURIComponent(TERMS.version) +
          "&ua=" + encodeURIComponent(navigator.userAgent || "") +
          "&t=" + Date.now();

        const res = await jsonp(url);
        if (res && res.ok) {
          setDot("ok");
          setStatusLines([
            "登録が完了しました。入店または退店へ進みます。",
            "Registration completed. Proceeding to check in/out.",
            "登记完成。将进入入店/退店页面。",
            "등록 완료. 입장/퇴장 화면으로 이동합니다."
          ]);
          showOverlay(false);
          showActions();
          await gateFlow();
        } else {
          if (res && res.code === "MISSING_FIELDS" && Array.isArray(res.missing)) {
            markErrorsFromServer_(res.missing);
          }
          setDot("error");
          setStatusLines([
            (res && res.message) ? res.message : "登録に失敗しました。もう一度お試しください。",
            "Registration failed. Please try again.",
            "登记失败。请重试。",
            "등록에 실패했습니다. 다시 시도해 주세요."
          ]);
        }
      } catch(e){
        setDot("error");
        setStatusLines(I18N.netErr);
      } finally {
        setBusy(false);
        elBadge.textContent = "準備中";
      }
    };

    btnModalSecondary.onclick = () => {
      showOverlay(false);
      setDot("error");
      setStatusLines([
        "会員情報の登録が完了していないため、入店退店はできません。",
        "You can't proceed without registration.",
        "未完成登记，无法继续。",
        "등록이 완료되지 않아 진행할 수 없습니다."
      ]);
      enableButtons(false);
    };

    function clearErrors_(){
      ["wrap_sei","wrap_mei","wrap_sei_kana","wrap_mei_kana","wrap_phone","wrap_addr"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.classList.remove("errField");
      });
      const c = document.getElementById("wrap_consent");
      if (c) c.classList.remove("errCheck");
      const t = document.getElementById("btnOpenTerms");
      if (t) t.style.boxShadow = "";
      if (t) t.style.borderColor = "";
    }

    function markErrors_(missing){
      if (missing.includes("sei")) document.getElementById("wrap_sei")?.classList.add("errField");
      if (missing.includes("mei")) document.getElementById("wrap_mei")?.classList.add("errField");
      if (missing.includes("sei_kana")) document.getElementById("wrap_sei_kana")?.classList.add("errField");
      if (missing.includes("mei_kana")) document.getElementById("wrap_mei_kana")?.classList.add("errField");
      if (missing.includes("phone")) document.getElementById("wrap_phone")?.classList.add("errField");
      if (missing.includes("address")) document.getElementById("wrap_addr")?.classList.add("errField");
      if (missing.includes("consent")) document.getElementById("wrap_consent")?.classList.add("errCheck");
      if (missing.includes("terms_opened")) {
        const t = document.getElementById("btnOpenTerms");
        if (t) {
          t.style.borderColor = "rgba(255,90,106,.55)";
          t.style.boxShadow = "0 0 0 4px rgba(255,90,106,.14)";
        }
      }
    }

    function markErrorsFromServer_(missingKeys){
      const m = new Set(missingKeys.map(x => String(x)));
      markErrors_([
        m.has("sei") ? "sei" : null,
        m.has("mei") ? "mei" : null,
        m.has("sei_kana") ? "sei_kana" : null,
        m.has("mei_kana") ? "mei_kana" : null,
        m.has("phone") ? "phone" : null,
        m.has("address") ? "address" : null,
        m.has("consent") ? "consent" : null
      ].filter(Boolean));
    }
  }

  async function callGAS(action){
    setBusy(true);
    elBadge.textContent = "処理中";
    setDot("busy");
    setStatusLines([
      "通信中です。しばらくお待ちください。",
      "Communicating... Please wait.",
      "正在通信…请稍候。",
      "통신 중입니다. 잠시만 기다려 주세요."
    ]);

    if (!withinRecentGeoOk()) {
      const geo = await verifyOnSite();
      if (!geo.ok) {
        setBusy(false);
        elBadge.textContent = "現地確認";
        setDot("error");
        if (geo.distM == null) setStatusLines(I18N.geoNeed);
        else setStatusLines(I18N.geoFar(Math.round(geo.distM)));
        return;
      }
    }

    const idToken = liff.getIDToken();
    if (!idToken) {
      setBusy(false);
      elBadge.textContent = "エラー";
      setDot("error");
      setStatusLines(I18N.tokenMissing);
      return;
    }

    try{
      const url = GAS_EXEC_URL + "?action=" + encodeURIComponent(action) + "&id_token=" + encodeURIComponent(idToken) + "&t=" + Date.now();
      const res = await jsonp(url);

      if (res && res.ok){
        elBadge.textContent = "完了";
        setDot("ok");
        const msgJa = res.message || "完了しました。";
        setStatusLines([
          msgJa,
          "Please operate the door now. Watch your step.",
          "请打开门并通过。请注意脚下的台阶。",
          "문을 열고 지나가 주세요. 단차에 주의하세요."
        ]);
      } else {
        if (res && res.code === "DENY_NEED_PROFILE") {
          showOverlay(true);
          renderProfileForm();
          return;
        }
        elBadge.textContent = "エラー";
        setDot("error");
        const msg = (res && res.message) ? res.message : "エラーが発生しました。";
        setStatusLines([
          msg + " もう一度お試しください。",
          "An error occurred. Please try again.",
          "发生错误。请重试。",
          "오류가 발생했습니다. 다시 시도해 주세요."
        ]);
      }
    } catch(e){
      elBadge.textContent = "エラー";
      setDot("error");
      setStatusLines(I18N.netErr);
    } finally{
      setBusy(false);
    }
  }

  function openConfirm(action){
    showOverlay(true);
    enableButtons(false);

    const cfg = action === "in" ? I18N.confirmIn : I18N.confirmOut;
    setModal(cfg);

    btnModalPrimary.onclick = async () => {
      showOverlay(false);
      enableButtons(false);
      await callGAS(action);
      enableButtons(true);
    };
    btnModalSecondary.onclick = () => {
      showOverlay(false);
      enableButtons(true);
    };
  }

  async function init(){
    elBadge.textContent = "起動中";
    setDot("busy");
    setStatusLines(I18N.init);
    enableButtons(false);

    try{
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
      await gateFlow();
   } catch (e) {
  elBadge.textContent = "エラー";
  setDot("error");

  const code = e && e.code ? String(e.code) : "";
  const msg  = e && e.message ? String(e.message) : "";
  const detail = (code || msg) ? ` (${code} ${msg})` : "";

  setStatusLines([
    "初期化に失敗しました。通信環境と設定を確認してください。" + detail,
    "Initialization failed. Check network and settings." + detail,
    "初始化失败。请检查网络和设置。" + detail,
    "초기화에 실패했습니다. 네트워크와 설정을 확인해 주세요." + detail
  ]);

  enableButtons(false);
}
  }

  btnIn.addEventListener("click", () => openConfirm("in"));
  btnOut.addEventListener("click", () => openConfirm("out"));

  document.addEventListener("visibilitychange", async () => {
    if (document.visibilityState === "visible") {
      await gateFlow();
    }
  });

  init();
</script>
</body>
</html>
