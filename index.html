<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>COMPASSION WORLD 入店退店管理システム</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    /* LIFF内で処理が止まるのを防ぐ */
    window.alert = function(){};
    window.confirm = function(){ return true; };
    window.prompt = function(){ return null; };
  </script>

  <style>
    :root{
      --bg:#0b0f1a; --card:#121a2b; --text:#e7ecff; --muted:#aab6da;
      --good:#1db954; --warn:#f4c542; --bad:#ff5a6a;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 30% -10%, #1a2a6c33, transparent),
        radial-gradient(900px 500px at 120% 20%, #b21f1f22, transparent),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      overflow:auto;
      padding:16px;
    }
    .app{ width:min(640px, 100%); margin:0 auto; }
    .card{
      background: linear-gradient(180deg, #141d33, var(--card));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:18px;
    }
    .header{display:flex; justify-content:space-between; gap:12px; margin-bottom:12px;}
    .title{font-size:16px; margin:0;}
    .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted);}

    .status{border:1px solid rgba(255,255,255,.1); border-radius:14px; padding:12px; margin-bottom:16px;}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--warn);display:inline-block;margin-right:8px;}

    .actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    button{
      border-radius:16px;
      padding:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
    }
    button:disabled{opacity:.5}

    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      overflow:auto;
      z-index:9999;
      padding:18px;
    }
    .overlay.show{display:block}
    .modal{
      background:#141d33;
      border-radius:20px;
      padding:16px;
      max-width:560px;
      margin:0 auto;
      max-height:calc(100vh - 36px);
      overflow:auto;
    }
    label{font-size:12px;color:var(--muted)}
    input,textarea{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:var(--text);
    }
    textarea{min-height:90px}
    .err{margin-top:10px;color:#ff8a8a;font-size:12px}
  </style>
</head>

<body>
<main class="app">
  <section class="card">
    <div class="header">
      <h1 class="title">COMPASSION WORLD 入店退店管理システム</h1>
      <div id="badge" class="badge">起動中</div>
    </div>

    <div class="status">
      <span id="dot" class="dot"></span>
      <span id="status">初期化中...</span>
    </div>

    <div class="actions">
      <button id="btnIn" disabled>入店</button>
      <button id="btnOut" disabled>退店</button>
    </div>
  </section>
</main>

<div id="overlay" class="overlay">
  <div class="modal">
    <h2 id="modalTitle"></h2>
    <div id="modalBody"></div>
    <div id="err" class="err"></div>
    <button id="modalPrimary"></button>
    <button id="modalSecondary"></button>
  </div>
</div>

<script>
const LIFF_ID = "2008818718-xTQWF4uO";

/* ★ あなたの最新GAS URL */
const GAS_EXEC_URL =
  "https://script.google.com/macros/s/AKfycbyOzhpcuV8C85ms5TvPbaUJutsCMFaHk9uFl9iqZ7x8jsw4aWj_WGVdvHsfHadj94sB/exec";

const badge = document.getElementById("badge");
const statusEl = document.getElementById("status");
const btnIn = document.getElementById("btnIn");
const btnOut = document.getElementById("btnOut");
const overlay = document.getElementById("overlay");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const errEl = document.getElementById("err");
const modalPrimary = document.getElementById("modalPrimary");
const modalSecondary = document.getElementById("modalSecondary");

function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    window[cb]=(d)=>{delete window[cb]; resolve(d);};
    const s=document.createElement("script");
    s.src=url+(url.includes("?")?"&":"?")+"callback="+cb;
    s.onerror=()=>reject();
    document.body.appendChild(s);
  });
}

function showModal(title, body, pText, pFn, sText, sFn){
  modalTitle.textContent=title;
  modalBody.innerHTML=body;
  errEl.textContent="";
  modalPrimary.textContent=pText;
  modalSecondary.textContent=sText;
  modalPrimary.onclick=pFn;
  modalSecondary.onclick=sFn;
  overlay.classList.add("show");
}

function hideModal(){ overlay.classList.remove("show"); }

async function call(action){
  const token=liff.getIDToken();
  const res=await jsonp(GAS_EXEC_URL+"?action="+action+"&id_token="+encodeURIComponent(token));
  statusEl.textContent=res.message||"";
}

async function init(){
  await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
  badge.textContent="準備OK";
  statusEl.textContent="入店または退店を選択してください。";
  btnIn.disabled=false;
  btnOut.disabled=false;
}

btnIn.onclick=()=>call("in");
btnOut.onclick=()=>call("out");

init();
</script>
</body>
</html>
