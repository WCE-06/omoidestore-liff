<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>COMPASSION WORLD 入店退店管理システム</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
:root{
  --bg:#0b0f1a; --card:#121a2b; --text:#e7ecff; --muted:#aab6da;
  --ok:#1db954; --warn:#f4c542; --err:#ff5a6a;
  --line:rgba(255,255,255,.15); --radius:18px;
  --shadow:0 10px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;
  background:
    radial-gradient(1200px 700px at 30% -10%, #1a2a6c33, transparent),
    radial-gradient(900px 500px at 120% 20%, #b21f1f22, transparent),
    var(--bg);
  color:var(--text);
  min-height:100vh;
  display:flex; align-items:center; justify-content:center;
  padding:16px;
}
.app{ width:min(720px, 100%); }
.card{
  background: linear-gradient(180deg, #141d33, var(--card));
  border:1px solid rgba(255,255,255,.08);
  box-shadow: var(--shadow);
  border-radius: var(--radius);
  padding: 18px;
}
.header{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:12px;}
.title{font-size:16px; margin:0; letter-spacing:.02em; line-height:1.35;}
.badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); background:rgba(255,255,255,.04); white-space:nowrap;}

.status{border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04); border-radius:14px; padding:12px; margin:12px 0 16px;}
.statusRow{display:flex; align-items:flex-start; gap:10px;}
.dot{width:10px; height:10px; border-radius:999px; margin-top:7px; background:var(--warn); box-shadow:0 0 0 4px rgba(244,197,66,.18); flex:0 0 auto;}
.i18nBlock{ line-height:1.45; }
.i18n-ja{ font-size:15px; color:var(--text); font-weight:650; white-space:pre-line; }
.i18n-sub{ margin-top:6px; display:grid; gap:4px; }
.i18n-sub div{ font-size:12px; color:var(--muted); white-space:pre-line; }

.hidden{ display:none !important; }

.actions{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
button{
  appearance:none; border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  border-radius:16px;
  padding:14px 12px;
  cursor:pointer;
  transition: transform .06s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
  user-select:none;
}
button:active{ transform: translateY(1px); }
button:disabled{ opacity:.55; cursor:not-allowed; }

.btnText{ text-align:center; }
.btnText .ja{ font-size:16px; font-weight:750; }
.btnText .sub{ margin-top:6px; display:grid; gap:4px; font-size:12px; color:var(--muted); line-height:1.2; }

.btnIn{ border-color: rgba(29,185,84,.35); background: linear-gradient(180deg, rgba(29,185,84,.22), rgba(255,255,255,.06)); }
.btnOut{ border-color: rgba(170,182,218,.25); background: linear-gradient(180deg, rgba(170,182,218,.14), rgba(255,255,255,.06)); }

.footerNote{ margin-top:14px; color:var(--muted); font-size:12px; line-height:1.6; white-space:pre-line; }

.overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
  display:none;
  align-items:center; justify-content:center;
  padding:18px;
  z-index:9999;
}
.overlay.show{ display:flex; }

.modal{
  width:min(640px, 100%);
  border-radius:20px;
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(20,29,51,.95), rgba(18,26,43,.95));
  box-shadow: var(--shadow);
  padding:16px;
}
.modalTop{ display:flex; align-items:center; gap:12px; justify-content:space-between; }
.modalTitle{ margin:0; font-size:15px; }
.pill{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); background:rgba(255,255,255,.04); white-space:nowrap; }

/* ここが重要: モーダル本文をスクロール可能にする */
.modalBody{
  margin-top:10px;
  max-height: 72vh;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}

.modalActions{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:14px; }
.btnPrimary{ border-color: rgba(29,185,84,.35); background: linear-gradient(180deg, rgba(29,185,84,.22), rgba(255,255,255,.06)); }
.btnGhost{ border-color: rgba(255,255,255,.16); background: rgba(255,255,255,.05); }

.form{ margin-top:12px; display:grid; gap:10px; }
.grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
.field{ display:grid; gap:6px; }
label{ font-size:12px; color:var(--muted); }
input, textarea{
  width:100%;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.18);
  color: var(--text);
  padding:12px 12px;
  font-size:14px;
  outline:none;
}
textarea{ min-height: 90px; resize: vertical; }

.field.err input, .field.err textarea{
  border-color: rgba(255,90,106,.9);
  box-shadow: 0 0 0 3px rgba(255,90,106,.18);
}

.checkRow{
  display:flex;
  gap:10px;
  align-items:flex-start;
  font-size:12px;
  color: var(--muted);
  line-height:1.6;
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  padding:10px;
}
.checkRow.err{
  border-color: rgba(255,90,106,.9);
  box-shadow: 0 0 0 3px rgba(255,90,106,.14);
}
.checkRow input{ width:18px; height:18px; margin-top:2px; }

.linkBtn{
  display:inline-block;
  margin-top:8px;
  font-size:12px;
  color:var(--text);
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.05);
  padding:8px 10px;
  border-radius:12px;
  cursor:pointer;
}

.termsBox{
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  background: rgba(0,0,0,.16);
  padding:12px;
  white-space:pre-wrap;
  font-size:12px;
  line-height:1.75;
  color:var(--muted);
  max-height: 56vh;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}

.srOnly{
  position:absolute; width:1px; height:1px;
  padding:0; margin:-1px; overflow:hidden;
  clip:rect(0,0,0,0); white-space:nowrap; border:0;
}
</style>
</head>

<body>
<main class="app">
  <section class="card" aria-live="polite" aria-busy="false">
    <div class="header">
      <h1 class="title">COMPASSION WORLD 入店退店管理システム</h1>
      <div id="badge" class="badge">起動中</div>
    </div>

    <div class="status" role="status" aria-atomic="true">
      <div class="statusRow">
        <div id="dot" class="dot" aria-hidden="true"></div>
        <div class="i18nBlock">
          <div id="statusJa" class="i18n-ja">初期化中...</div>
          <div class="i18n-sub">
            <div id="statusEn">Initializing...</div>
            <div id="statusZh">正在初始化...</div>
            <div id="statusKo">초기화 중...</div>
          </div>
        </div>
      </div>
    </div>

    <div id="ioArea" class="actions hidden">
      <button id="btnIn" class="btnIn" disabled>
        <div class="btnText">
          <div class="ja">入店</div>
          <div class="sub">
            <div>Check in</div>
            <div>进入</div>
            <div>입장</div>
          </div>
        </div>
      </button>

      <button id="btnOut" class="btnOut" disabled>
        <div class="btnText">
          <div class="ja">退店</div>
          <div class="sub">
            <div>Check out</div>
            <div>离开</div>
            <div>퇴장</div>
          </div>
        </div>
      </button>
    </div>

    <div id="regHint" class="footerNote hidden">
COMPASSION WORLDが
平和で心地よい世界であり続けるために

COMPASSION WORLDは、
訪れるすべての方が安心して過ごせる
平和であたたかな世界であることを大切にしています。
その世界を守り続けるため、
初めてご利用いただく際のみ、
会員登録へのご協力をお願いしています。
ご登録後は、入店・退店の操作のみで
スムーズにご利用いただけます。
    </div>

    <div id="ioHint" class="footerNote hidden">
処理中はボタンが押せません。画面の案内に沿って操作してください。
Buttons are disabled during processing. Please follow the on-screen instructions.
处理过程中按钮不可用。请按照屏幕提示操作。
처리 중에는 버튼을 사용할 수 없습니다. 화면 안내에 따라 주세요.
    </div>
  </section>
</main>

<div id="overlay" class="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalTop">
      <h2 id="modalTitle" class="modalTitle">確認</h2>
      <div id="modalPill" class="pill">案内</div>
    </div>

    <div class="modalBody">
      <div class="i18nBlock">
        <div id="modalJa" class="i18n-ja">確認中...</div>
        <div class="i18n-sub">
          <div id="modalEn">Checking...</div>
          <div id="modalZh">正在确认...</div>
          <div id="modalKo">확인 중...</div>
        </div>
      </div>

      <div id="modalForm" style="display:none;"></div>

      <div class="modalActions">
        <button id="btnModalPrimary" class="btnPrimary" disabled>...</button>
        <button id="btnModalSecondary" class="btnGhost" disabled>...</button>
      </div>

      <div class="srOnly" id="srLive" aria-live="assertive"></div>
    </div>
  </div>
</div>

<div id="termsOverlay" class="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="termsTitle">
    <div class="modalTop">
      <h2 id="termsTitle" class="modalTitle">利用規約</h2>
      <div class="pill">確認</div>
    </div>
    <div class="modalBody">
      <div class="termsBox" id="termsText"></div>
      <div class="modalActions" style="margin-top:14px;">
        <button id="btnTermsOk" class="btnPrimary">確認しました</button>
        <button id="btnTermsBack" class="btnGhost">戻る</button>
      </div>
    </div>
  </div>
</div>

<script>
const LIFF_ID = "2008818718-fOO0L9iV";
const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbzbu1TRotcgjS0beSRhZqYIznvSgbyMZ0UpsQZ9Pgw5uUGkO6Smf9HdP1O-cLqLnvvz/exec";

const I18N = {
  ready: [
    "準備ができました。入店または退店を押してください。",
    "Ready. Tap Check in or Check out.",
    "准备就绪。请选择进入或离开。",
    "준비 완료. 입장 또는 퇴장을 눌러 주세요."
  ],
  initFail: [
    "初期化に失敗しました。通信環境と設定を確認してください。",
    "Initialization failed. Check network and settings.",
    "初始化失败。请检查网络和设置。",
    "초기화에 실패했습니다. 네트워크와 설정을 확인해 주세요."
  ],
  tokenMissing: [
    "認証情報を取得できませんでした。LINEを開き直してお試しください。",
    "Could not get authentication info. Please reopen LINE and try again.",
    "无法获取认证信息。请重新打开LINE后重试。",
    "인증 정보를 가져올 수 없습니다. LINE을 다시 열고 시도해 주세요."
  ],
  netErr: [
    "通信エラーまたはタイムアウトです。電波状況を確認してお試しください。",
    "Network error or timeout. Check your connection.",
    "通信错误或超时。请检查网络。",
    "통신 오류 또는 시간 초과. 네트워크를 확인해 주세요."
  ],
  confirmIn: {
    title: "確認", pill: "入店",
    body: ["入店を記録します。よろしいですか。","You are about to check in. Continue?","将记录进入。继续吗？","입장을 기록합니다. 진행할까요?"],
    primary: "入店する", secondary: "やめる"
  },
  confirmOut: {
    title: "確認", pill: "退店",
    body: ["退店を記録します。よろしいですか。","You are about to check out. Continue?","将记录离开。继续吗？","퇴장을 기록합니다. 진행할까요?"],
    primary: "退店する", secondary: "やめる"
  }
};

const TERMS_TEXT = `第1条 目的
本規約は、COMPASSION WORLD 入店退店管理システムを利用するすべての利用者に対し、施設の安全な運営、緊急時の連絡を目的として、会員情報の取得および利用条件を定めるものです。

第2条 会員登録
本システムを利用して入店または退店を行う場合、初回利用時に以下の会員情報の登録が必要となります。
・姓
・名
・姓（カナ）
・名（カナ）
・生年月日
・住所
・電話番号
利用者は、正確かつ最新の情報を登録するものとします。

第3条 個人情報の利用目的
取得した個人情報は、以下の目的の範囲内で利用します。
・施設の入退店履歴の管理
・緊急時における利用者への連絡
・安心して過ごせる環境づくりのための確認
・法令に基づく対応および手続

第4条 店内備品等の破損・汚損
利用者の故意または過失、または通常の使用方法を超える利用により、店内備品、設備、商品、建物その他の物品に破損、汚損、紛失等の損害が生じた場合、当施設は、修理または交換に要する合理的な実費相当額を請求できるものとし、利用者はこれを負担します。
通常の利用による経年劣化、通常損耗に該当するものは、原則として請求の対象外とします。

第5条 個人情報の管理
取得した個人情報は、漏えい、紛失、改ざん等を防止するため、適切な安全管理措置を講じて管理します。

第6条 個人情報の第三者提供
以下の場合を除き、本人の同意なく第三者に提供することはありません。
・法令に基づく場合
・警察、裁判所等の公的機関から正当な要請を受けた場合
・利用者または第三者の生命、身体、財産の保護のために必要な場合

第7条 入店退店の制限
会員登録が完了していない場合、または虚偽の情報が登録されていると判断された場合、本システムによる入店および退店をお断りすることがあります。

第8条 規約の変更
本規約は、必要に応じて予告なく変更されることがあります。変更後の規約は、本システム上に表示された時点で効力を生じます。

第9条 同意の成立
本規約は、利用者が規約内容を確認し、同意の意思表示を行ったうえで会員登録を送信した時点で成立するものとします。
`;

const elBadge = document.getElementById("badge");
const elDot = document.getElementById("dot");
const elStatusJa = document.getElementById("statusJa");
const elStatusEn = document.getElementById("statusEn");
const elStatusZh = document.getElementById("statusZh");
const elStatusKo = document.getElementById("statusKo");

const ioArea = document.getElementById("ioArea");
const regHint = document.getElementById("regHint");
const ioHint = document.getElementById("ioHint");

const btnIn = document.getElementById("btnIn");
const btnOut = document.getElementById("btnOut");
const card = document.querySelector(".card");

const overlay = document.getElementById("overlay");
const modalTitle = document.getElementById("modalTitle");
const modalPill = document.getElementById("modalPill");
const modalJa = document.getElementById("modalJa");
const modalEn = document.getElementById("modalEn");
const modalZh = document.getElementById("modalZh");
const modalKo = document.getElementById("modalKo");
const modalForm = document.getElementById("modalForm");
const btnModalPrimary = document.getElementById("btnModalPrimary");
const btnModalSecondary = document.getElementById("btnModalSecondary");
const srLive = document.getElementById("srLive");

const termsOverlay = document.getElementById("termsOverlay");
const termsText = document.getElementById("termsText");
const btnTermsOk = document.getElementById("btnTermsOk");
const btnTermsBack = document.getElementById("btnTermsBack");

let idToken = "";
let termsAccepted = false;

/* 入力内容を保持して消えないようにする */
const formState = {
  last: "", first: "", lastKana: "", firstKana: "",
  dob: "", phone: "", addr: ""
};

function setDot(state){
  if (state === "ok") { elDot.style.background = "var(--ok)"; elDot.style.boxShadow = "0 0 0 4px rgba(29,185,84,.18)"; return; }
  if (state === "busy") { elDot.style.background = "var(--warn)"; elDot.style.boxShadow = "0 0 0 4px rgba(244,197,66,.18)"; return; }
  if (state === "error") { elDot.style.background = "var(--err)"; elDot.style.boxShadow = "0 0 0 4px rgba(255,90,106,.18)"; return; }
  elDot.style.background = "var(--warn)";
  elDot.style.boxShadow = "0 0 0 4px rgba(244,197,66,.18)";
}

function setStatusLines(lines){
  elStatusJa.textContent = lines[0] || "";
  elStatusEn.textContent = lines[1] || "";
  elStatusZh.textContent = lines[2] || "";
  elStatusKo.textContent = lines[3] || "";
  srLive.textContent = lines[0] || "";
}

function enableButtons(ready){
  btnIn.disabled = !ready;
  btnOut.disabled = !ready;
}

function showOverlay(show){
  overlay.classList.toggle("show", !!show);
  overlay.setAttribute("aria-hidden", show ? "false" : "true");
}

function showTerms(show){
  termsOverlay.classList.toggle("show", !!show);
  termsOverlay.setAttribute("aria-hidden", show ? "false" : "true");
}

function setBusy(on){
  card.setAttribute("aria-busy", on ? "true" : "false");
  enableButtons(!on);
}

function setModal(cfg){
  modalTitle.textContent = cfg.title || "";
  modalPill.textContent = cfg.pill || "";
  modalJa.textContent = (cfg.body && cfg.body[0]) || "";
  modalEn.textContent = (cfg.body && cfg.body[1]) || "";
  modalZh.textContent = (cfg.body && cfg.body[2]) || "";
  modalKo.textContent = (cfg.body && cfg.body[3]) || "";
  srLive.textContent = (cfg.body && cfg.body[0]) || "";
  btnModalPrimary.textContent = cfg.primary || "";
  btnModalSecondary.textContent = cfg.secondary || "";
  btnModalPrimary.disabled = false;
  btnModalSecondary.disabled = false;
  modalForm.style.display = "none";
  modalForm.innerHTML = "";
}

function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    window[cb] = (data) => { cleanup(); resolve(data); };

    const script = document.createElement("script");
    const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, 20000);

    function cleanup() {
      clearTimeout(timer);
      if (script.parentNode) script.parentNode.removeChild(script);
      delete window[cb];
    }

    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + encodeURIComponent(cb);
    script.onerror = () => { cleanup(); reject(new Error("load error")); };

    document.body.appendChild(script);
  });
}

async function gasCall(action, paramsObj){
  if (!idToken) return { ok:false, code:"NO_TOKEN", message:I18N.tokenMissing[0] };

  const p = new URLSearchParams();
  p.set("action", action);
  p.set("id_token", idToken);
  p.set("t", String(Date.now()));
  if (paramsObj) for (const k of Object.keys(paramsObj)) p.set(k, String(paramsObj[k]));
  const url = GAS_EXEC_URL + "?" + p.toString();
  return await jsonp(url);
}

async function ensureProfileOrShowForm(){
  const st = await gasCall("profile_status");
  if (st && st.ok && st.has_profile) {
    showOverlay(false);
    ioArea.classList.remove("hidden");
    regHint.classList.add("hidden");
    ioHint.classList.remove("hidden");
    elBadge.textContent = "準備OK";
    setDot("ok");
    setStatusLines(I18N.ready);
    enableButtons(true);
    return true;
  }

  ioArea.classList.add("hidden");
  regHint.classList.remove("hidden");
  ioHint.classList.add("hidden");
  showOverlay(true);
  renderProfileForm();
  return false;
}

function renderProfileForm(){
  setModal({
    title: "COMPASSION WORLDが平和で心地よい世界であり続けるために",
    pill: "初回会員登録",
    body: [
      "COMPASSION WORLDは、
訪れるすべての方が安心して過ごせる
平和であたたかな世界であることを大切にしています。
その世界を守り続けるため、
初めてご利用いただく際のみ、
会員登録へのご協力をお願いしています。
ご登録後は、入店・退店の操作のみで
スムーズにご利用いただけます。",
      "One-time registration is required.",
      "首次需要登记。",
      "최초 1회 등록이 필요합니다."
    ],
    primary: "登録を送信",
    secondary: "閉じる"
  });

  modalForm.style.display = "block";
  modalForm.innerHTML = `
    <div class="form">
      <div class="grid2">
        <div class="field" id="w_last">
          <label>姓</label>
          <input id="f_last" type="text" autocomplete="family-name" />
        </div>
        <div class="field" id="w_first">
          <label>名</label>
          <input id="f_first" type="text" autocomplete="given-name" />
        </div>
      </div>

      <div class="grid2">
        <div class="field" id="w_last_kana">
          <label>セイ</label>
          <input id="f_last_kana" type="text" inputmode="kana" />
        </div>
        <div class="field" id="w_first_kana">
          <label>メイ</label>
          <input id="f_first_kana" type="text" inputmode="kana" />
        </div>
      </div>

      <div class="grid2">
        <div class="field" id="w_dob">
          <label>生年月日</label>
          <input id="f_dob" type="date" />
        </div>
        <div class="field" id="w_phone">
          <label>電話番号</label>
          <input id="f_phone" type="tel" autocomplete="tel" />
        </div>
      </div>

      <div class="field" id="w_addr">
        <label>住所</label>
        <textarea id="f_addr"></textarea>
      </div>

      <div class="checkRow" id="w_consent">
        <input id="f_consent" type="checkbox" ${termsAccepted ? "" : "disabled"} ${termsAccepted ? "checked" : ""} />
        <div>
          本システムが、COMPASSION WORLDの平和な世界を守るために利用されることに同意します

        
          <div class="linkBtn" id="openTermsBtn">利用規約を表示する</div>
        </div>
      </div>
    </div>
  `;

  const fLast = document.getElementById("f_last");
  const fFirst = document.getElementById("f_first");
  const fLastKana = document.getElementById("f_last_kana");
  const fFirstKana = document.getElementById("f_first_kana");
  const fDob = document.getElementById("f_dob");
  const fPhone = document.getElementById("f_phone");
  const fAddr = document.getElementById("f_addr");
  const fConsent = document.getElementById("f_consent");

  fLast.value = formState.last;
  fFirst.value = formState.first;
  fLastKana.value = formState.lastKana;
  fFirstKana.value = formState.firstKana;
  fDob.value = formState.dob;
  fPhone.value = formState.phone;
  fAddr.value = formState.addr;

  const bind = (el, key) => el.addEventListener("input", () => { formState[key] = el.value; });
  bind(fLast, "last");
  bind(fFirst, "first");
  bind(fLastKana, "lastKana");
  bind(fFirstKana, "firstKana");
  bind(fDob, "dob");
  bind(fPhone, "phone");
  bind(fAddr, "addr");

  document.getElementById("openTermsBtn").onclick = () => {
    termsText.textContent = TERMS_TEXT;
    showTerms(true);
  };

  btnModalPrimary.onclick = async () => {
    window.scrollTo({ top: 0, behavior: "smooth" });

    const last = fLast.value.trim();
    const first = fFirst.value.trim();
    const lastKana = fLastKana.value.trim();
    const firstKana = fFirstKana.value.trim();
    const dob = fDob.value.trim();
    const phone = fPhone.value.trim();
    const addr = fAddr.value.trim();
    const consent = fConsent.checked;

    const setErr = (id, on) => document.getElementById(id).classList.toggle("err", !!on);
    setErr("w_last", !last);
    setErr("w_first", !first);
    setErr("w_last_kana", !lastKana);
    setErr("w_first_kana", !firstKana);
    setErr("w_dob", !dob);
    setErr("w_phone", !phone);
    setErr("w_addr", !addr);
    document.getElementById("w_consent").classList.toggle("err", !consent);

    if (!last || !first || !lastKana || !firstKana || !dob || !phone || !addr || !consent) {
      setDot("error");
      setStatusLines([
        "未入力の項目があります。未入力欄が赤く表示されます。",
        "Some fields are missing. Missing fields are highlighted in red.",
        "有未填写项目。未填写项将以红色标示。",
        "미입력 항목이 있습니다. 미입력 항목이 빨간색으로 표시됩니다."
      ]);
      return;
    }

    setBusy(true);
    elBadge.textContent = "送信中";
    setDot("busy");

    try{
      const res = await gasCall("profile_set", {
        last_name: last,
        first_name: first,
        last_kana: lastKana,
        first_kana: firstKana,
        dob: dob,
        phone: phone,
        address: addr,
        consent: "true"
      });

      if (res && res.ok) {
        setDot("ok");
        setStatusLines([
          "登録が完了しました。続けて入店または退店を操作できます。",
          "Registration completed. You can now check in or check out.",
          "登记完成。现在可以进入或离开。",
          "등록 완료. 이제 입장 또는 퇴장을 할 수 있습니다."
        ]);
        showOverlay(false);
        await ensureProfileOrShowForm();
      } else {
        setDot("error");
        setStatusLines([
          (res && res.message) ? res.message : "登録に失敗しました。もう一度お試しください。",
          "Registration failed. Please try again.",
          "登记失败。请重试。",
          "등록에 실패했습니다. 다시 시도해 주세요."
        ]);
      }
    } catch(e){
      setDot("error");
      setStatusLines(I18N.netErr);
    } finally {
      setBusy(false);
      elBadge.textContent = "準備中";
    }
  };

  btnModalSecondary.onclick = () => {
    showOverlay(false);
    setDot("error");
    setStatusLines([
      "会員登録が完了していないため、入店退店はできません。",
      "You can't proceed without registration.",
      "未完成登记，无法继续。",
      "등록이 완료되지 않아 진행할 수 없습니다."
    ]);
    enableButtons(false);
  };
}

/* 規約画面のボタン */
btnTermsOk.onclick = () => {
  termsAccepted = true;
  showTerms(false);

  const c = document.getElementById("f_consent");
  if (c) {
    c.disabled = false;
    c.checked = true;
  }

  setDot("ok");
  setStatusLines([
    "利用規約を確認しました。同意にチェックできるようになりました。",
    "Terms confirmed. Consent checkbox is now enabled.",
    "已确认条款。同意选项已启用。",
    "약관 확인 완료. 동의 체크가 활성화되었습니다."
  ]);
};

btnTermsBack.onclick = () => {
  showTerms(false);
};

async function callActionWithConfirm(action){
  showOverlay(true);
  enableButtons(false);

  const cfg = action === "check_in" ? I18N.confirmIn : I18N.confirmOut;
  setModal(cfg);

  btnModalPrimary.onclick = async () => {
    showOverlay(false);
    enableButtons(false);
    setBusy(true);
    elBadge.textContent = "処理中";
    setDot("busy");
    setStatusLines([
      "通信中です。しばらくお待ちください。",
      "Communicating... Please wait.",
      "正在通信…请稍候。",
      "통신 중입니다. 잠시만 기다려 주세요."
    ]);

    try{
      const res = await gasCall(action);
      if (res && res.ok) {
        elBadge.textContent = "完了";
        setDot("ok");
        setStatusLines([
          res.message || "完了しました。",
          "Please operate the door now. Watch your step.",
          "请打开门并通过。请注意脚下的台阶。",
          "문을 열고 지나가 주세요. 단차에 주의하세요."
        ]);
      } else {
        elBadge.textContent = "エラー";
        setDot("error");
        setStatusLines([
          (res && res.message) ? (res.message + " もう一度お試しください。") : "エラーが発生しました。もう一度お試しください。",
          "An error occurred. Please try again.",
          "发生错误。请重试。",
          "오류가 발생했습니다. 다시 시도해 주세요."
        ]);
      }
    } catch(e){
      elBadge.textContent = "エラー";
      setDot("error");
      setStatusLines(I18N.netErr);
    } finally{
      setBusy(false);
      enableButtons(true);
    }
  };

  btnModalSecondary.onclick = () => {
    showOverlay(false);
    enableButtons(true);
  };
}

async function init(){
  elBadge.textContent = "起動中";
  setDot("busy");
  setStatusLines(["初期化中...", "Initializing...", "正在初始化...", "초기화 중..."]);
  enableButtons(false);

  try{
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
    if (!liff.isLoggedIn()) { liff.login(); return; }

    idToken = liff.getIDToken() || "";
    if (!idToken) {
      elBadge.textContent = "エラー";
      setDot("error");
      setStatusLines(I18N.tokenMissing);
      return;
    }

    await ensureProfileOrShowForm();
  }catch(e){
    elBadge.textContent = "エラー";
    setDot("error");
    setStatusLines(I18N.initFail);
    enableButtons(false);
  }
}

btnIn.addEventListener("click", () => callActionWithConfirm("check_in"));
btnOut.addEventListener("click", () => callActionWithConfirm("check_out"));

document.addEventListener("visibilitychange", async () => {
  if (document.visibilityState === "visible") {
    try{
      if (window.liff && liff.isLoggedIn()) idToken = liff.getIDToken() || idToken;
      await ensureProfileOrShowForm();
    } catch(e){}
  }
});

init();
</script>
</body>
</html>
