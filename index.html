<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>COMPASSION WORLD 入店退店管理システム</title>
  <style>
    :root{
      --bg:#0b0f1a; --card:#121a2b; --text:#e7ecff; --muted:#aab6da;
      --good:#1db954; --warn:#f4c542; --bad:#ff5a6a;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 18px;
      --line:#00c300;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 30% -10%, #1a2a6c33, transparent),
        radial-gradient(900px 500px at 120% 20%, #b21f1f22, transparent),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .app{ width:min(720px, 100%); }
    .card{
      background: linear-gradient(180deg, #141d33, var(--card));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 18px;
    }
    .header{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:12px;}
    .title{font-size:16px; margin:0; letter-spacing:.02em; line-height:1.35;}
    .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); background:rgba(255,255,255,.04); white-space:nowrap;}

    .status{border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04); border-radius:14px; padding:12px; margin:12px 0 16px;}
    .statusRow{display:flex; align-items:flex-start; gap:10px;}
    .dot{width:10px; height:10px; border-radius:999px; margin-top:7px; background:var(--warn); box-shadow:0 0 0 4px rgba(244,197,66,.18); flex:0 0 auto;}

    .i18nBlock{ line-height:1.45; }
    .i18n-ja{ font-size:15px; color:var(--text); font-weight:650; }
    .i18n-sub{ margin-top:6px; display:grid; gap:4px; }
    .i18n-sub div{ font-size:12px; color:var(--muted); }

    .actions{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    button{
      appearance:none; border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:16px;
      padding:14px 12px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      user-select:none;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnText{ text-align:center; }
    .btnText .ja{ font-size:16px; font-weight:750; }
    .btnText .sub{ margin-top:6px; display:grid; gap:4px; font-size:12px; color:var(--muted); line-height:1.2; }

    .btnIn{ border-color: rgba(29,185,84,.35); background: linear-gradient(180deg, rgba(29,185,84,.22), rgba(255,255,255,.06)); }
    .btnOut{ border-color: rgba(170,182,218,.25); background: linear-gradient(180deg, rgba(170,182,218,.14), rgba(255,255,255,.06)); }
    .btnLine{ border-color: rgba(0,195,0,.45); background: linear-gradient(180deg, rgba(0,195,0,.24), rgba(255,255,255,.06)); }
    .btnGhost{ border-color: rgba(255,255,255,.16); background: rgba(255,255,255,.05); }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .form{ margin-top:12px; display:grid; gap:10px; }
    .field{ display:grid; gap:6px; }
    label{ font-size:12px; color:var(--muted); }
    input, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }
    textarea{ min-height: 90px; resize: vertical; }
    .err{
      border-color: rgba(255,90,106,.9) !important;
      box-shadow: 0 0 0 4px rgba(255,90,106,.18);
    }
    .checkRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
    }
    .checkRow.err{
      border-color: rgba(255,90,106,.9);
      box-shadow: 0 0 0 4px rgba(255,90,106,.18);
    }
    .checkRow input{ width:18px; height:18px; margin-top:2px; }
    .note{
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
      margin-top:10px;
    }
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(640px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(20,29,51,.95), rgba(18,26,43,.95));
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modalTop{ display:flex; align-items:center; gap:12px; justify-content:space-between; }
    .modalTitle{ margin:0; font-size:15px; }
    .pill{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); background:rgba(255,255,255,.04); white-space:nowrap; }
    .modalActions{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:14px; }
  </style>
</head>

<body>
  <main class="app">
    <section class="card" aria-live="polite" aria-busy="false">
      <div class="header">
        <h1 class="title">COMPASSION WORLD 入店退店管理システム</h1>
        <div id="badge" class="badge">起動中</div>
      </div>

      <div class="status" role="status" aria-atomic="true">
        <div class="statusRow">
          <div id="dot" class="dot" aria-hidden="true"></div>
          <div class="i18nBlock">
            <div id="statusJa" class="i18n-ja">初期化中...</div>
            <div class="i18n-sub">
              <div id="statusEn">Initializing...</div>
              <div id="statusZh">正在初始化...</div>
              <div id="statusKo">초기화 중...</div>
            </div>
          </div>
        </div>
      </div>

      <div id="loginArea" style="display:none;">
        <button id="btnLogin" class="btnLine">
          <div class="btnText">
            <div class="ja">LINEでログイン</div>
            <div class="sub">
              <div>Login with LINE</div>
              <div>使用LINE登录</div>
              <div>LINE으로 로그인</div>
            </div>
          </div>
        </button>
        <div class="note">
          初回のみ、LINEログインが必要です。ログイン後は入店・退店の操作のみでご利用いただけます。
          <div class="i18n-sub" style="margin-top:8px;">
            <div>Only the first time. After login, you can simply check in/out.</div>
            <div>仅首次需要登录。之后只需进入/离开操作。</div>
            <div>최초 1회만 필요합니다. 이후 입장/퇴장만 하면 됩니다.</div>
          </div>
        </div>
      </div>

      <div id="actionsArea" style="display:none;">
        <div class="actions">
          <button id="btnIn" class="btnIn" disabled>
            <div class="btnText">
              <div class="ja">入店</div>
              <div class="sub">
                <div>Check in</div>
                <div>进入</div>
                <div>입장</div>
              </div>
            </div>
          </button>

          <button id="btnOut" class="btnOut" disabled>
            <div class="btnText">
              <div class="ja">退店</div>
              <div class="sub">
                <div>Check out</div>
                <div>离开</div>
                <div>퇴장</div>
              </div>
            </div>
          </button>
        </div>

        <div class="note">
          COMPASSION WORLDが平和で心地よい世界であり続けるために、ご協力をお願いします。
          <div class="i18n-sub" style="margin-top:8px;">
            <div>Thank you for helping keep COMPASSION WORLD peaceful and comfortable.</div>
            <div>感谢协助维护 COMPASSION WORLD 的平和与舒适。</div>
            <div>COMPASSION WORLD가 평화롭고 편안한 공간으로 유지되도록 협조 부탁드립니다.</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalTop">
        <h2 id="modalTitle" class="modalTitle">会員情報の登録</h2>
        <div class="pill">初回のみ</div>
      </div>

      <div class="note" style="margin-top:10px;">
        初めてご利用いただく際のみ、会員登録へのご協力をお願いしています。ご登録後は、入店・退店の操作のみでスムーズにご利用いただけます。
      </div>

      <div class="form">
        <div class="grid2">
          <div class="field">
            <label>姓</label>
            <input id="f_last" type="text" autocomplete="family-name" />
          </div>
          <div class="field">
            <label>名</label>
            <input id="f_first" type="text" autocomplete="given-name" />
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>セイ</label>
            <input id="f_last_kana" type="text" inputmode="kana" />
          </div>
          <div class="field">
            <label>メイ</label>
            <input id="f_first_kana" type="text" inputmode="kana" />
          </div>
        </div>

        <div class="field">
          <label>電話番号</label>
          <input id="f_phone" type="tel" autocomplete="tel" />
        </div>

        <div class="field">
          <label>住所</label>
          <textarea id="f_addr"></textarea>
        </div>

        <div class="checkRow" id="agreeBox">
          <input id="f_consent" type="checkbox" />
          <div>
            本システムが、COMPASSION WORLDの平和な世界を守るために利用されることに同意します
          </div>
        </div>

        <div class="modalActions">
          <button id="btnSubmit" class="btnLine">登録を送信</button>
          <button id="btnClose" class="btnGhost">閉じる</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzWz9IH93wc73_Kf1sS52jNb67l1Hjq9N1nSOXGXtMjSFPGA4djbDQNuKAAz_O0uaIx/exec";
  const RETURN_URL = "https://wce-06.github.io/omoidestore-liff/";

  const elBadge = document.getElementById("badge");
  const elDot = document.getElementById("dot");
  const statusJa = document.getElementById("statusJa");
  const statusEn = document.getElementById("statusEn");
  const statusZh = document.getElementById("statusZh");
  const statusKo = document.getElementById("statusKo");

  const loginArea = document.getElementById("loginArea");
  const actionsArea = document.getElementById("actionsArea");
  const btnLogin = document.getElementById("btnLogin");
  const btnIn = document.getElementById("btnIn");
  const btnOut = document.getElementById("btnOut");

  const overlay = document.getElementById("overlay");
  const btnSubmit = document.getElementById("btnSubmit");
  const btnClose = document.getElementById("btnClose");

  const f_last = document.getElementById("f_last");
  const f_first = document.getElementById("f_first");
  const f_last_kana = document.getElementById("f_last_kana");
  const f_first_kana = document.getElementById("f_first_kana");
  const f_phone = document.getElementById("f_phone");
  const f_addr = document.getElementById("f_addr");
  const f_consent = document.getElementById("f_consent");
  const agreeBox = document.getElementById("agreeBox");

  function setDot(state){
    if (state === "ok") { elDot.style.background = "var(--good)"; elDot.style.boxShadow = "0 0 0 4px rgba(29,185,84,.18)"; return; }
    if (state === "busy") { elDot.style.background = "var(--warn)"; elDot.style.boxShadow = "0 0 0 4px rgba(244,197,66,.18)"; return; }
    elDot.style.background = "var(--bad)";
    elDot.style.boxShadow = "0 0 0 4px rgba(255,90,106,.18)";
  }

  function setStatus(lines){
    statusJa.textContent = lines[0] || "";
    statusEn.textContent = lines[1] || "";
    statusZh.textContent = lines[2] || "";
    statusKo.textContent = lines[3] || "";
  }

  function enableButtons(on){
    btnIn.disabled = !on;
    btnOut.disabled = !on;
  }

  function showOverlay(on){
    overlay.classList.toggle("show", !!on);
    overlay.setAttribute("aria-hidden", on ? "false" : "true");
  }

  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      window[cb] = (data) => { cleanup(); resolve(data); };

      const s = document.createElement("script");
      const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, 20000);

      function cleanup(){
        clearTimeout(timer);
        if (s.parentNode) s.parentNode.removeChild(s);
        delete window[cb];
      }

      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "callback=" + encodeURIComponent(cb);
      s.onerror = () => { cleanup(); reject(new Error("load error")); };
      document.body.appendChild(s);
    });
  }

  function getSession(){
    const fromHash = new URLSearchParams(location.hash.replace(/^#/, "")).get("session");
    if (fromHash) {
      localStorage.setItem("cw_session", fromHash);
      history.replaceState(null, "", location.pathname + location.search);
    }
    return localStorage.getItem("cw_session") || "";
  }

  function clearErrors(){
    [f_last,f_first,f_last_kana,f_first_kana,f_phone,f_addr].forEach(el => el.classList.remove("err"));
    agreeBox.classList.remove("err");
  }

  function markMissing(missing){
    const map = {
      last_name: f_last,
      first_name: f_first,
      last_kana: f_last_kana,
      first_kana: f_first_kana,
      phone: f_phone,
      address: f_addr,
      consent: agreeBox
    };
    missing.forEach(k => {
      const el = map[k];
      if (!el) return;
      el.classList.add("err");
    });
  }

  function getGeo(){
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject(new Error("no geo"));
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
        (err) => reject(err),
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
      );
    });
  }

  async function ensureProfile(session){
    const r = await jsonp(GAS_WEBAPP_URL + "?action=api&op=profile_status&session=" + encodeURIComponent(session) + "&t=" + Date.now());
    if (r && r.ok && r.has_profile) return true;
    showOverlay(true);
    return false;
  }

  async function submitProfile(session){
    clearErrors();
    window.scrollTo({ top: 0, behavior: "smooth" });

    setDot("busy");
    elBadge.textContent = "送信中";
    setStatus(["登録を送信しています...", "Sending...", "正在发送...", "전송 중..."]);

    const url =
      GAS_WEBAPP_URL + "?action=api&op=profile_set" +
      "&session=" + encodeURIComponent(session) +
      "&last_name=" + encodeURIComponent(f_last.value.trim()) +
      "&first_name=" + encodeURIComponent(f_first.value.trim()) +
      "&last_kana=" + encodeURIComponent(f_last_kana.value.trim()) +
      "&first_kana=" + encodeURIComponent(f_first_kana.value.trim()) +
      "&phone=" + encodeURIComponent(f_phone.value.trim()) +
      "&address=" + encodeURIComponent(f_addr.value.trim()) +
      "&consent=" + encodeURIComponent(String(!!f_consent.checked)) +
      "&t=" + Date.now();

    const r = await jsonp(url);
    if (r && r.ok) {
      setDot("ok");
      elBadge.textContent = "完了";
      setStatus(["登録が完了しました。", "Registration completed.", "登记完成。", "등록 완료."]);
      showOverlay(false);
      return true;
    }

    elBadge.textContent = "エラー";
    setDot("bad");
    if (r && r.code === "MISSING") {
      setStatus(["未入力の項目があります。赤く表示された箇所をご確認ください。", "Missing fields. Check red fields.", "有未填写项目，请检查红色标记。", "미입력 항목이 있습니다. 빨간 표시를 확인해 주세요."]);
      markMissing(r.missing || []);
      return false;
    }
    setStatus([ (r && r.message) ? r.message : "登録に失敗しました。", "Failed.", "失败。", "실패。" ]);
    return false;
  }

  async function doCheck(op){
    const session = getSession();
    if (!session) return;

    enableButtons(false);
    setDot("busy");
    elBadge.textContent = "処理中";
    setStatus(["位置情報を確認しています...", "Checking location...", "正在确认位置...", "위치 확인 중..."]);

    let geo;
    try {
      geo = await getGeo();
    } catch(e) {
      setDot("bad");
      elBadge.textContent = "エラー";
      setStatus(["位置情報を取得できませんでした。許可設定をご確認ください。", "Could not get location.", "无法获取位置。", "위치를 가져오지 못했습니다."]);
      enableButtons(true);
      return;
    }

    setStatus(["通信中です...", "Communicating...", "正在通信...", "통신 중..."]);
    const url =
      GAS_WEBAPP_URL + "?action=api&op=" + encodeURIComponent(op) +
      "&session=" + encodeURIComponent(session) +
      "&lat=" + encodeURIComponent(String(geo.lat)) +
      "&lng=" + encodeURIComponent(String(geo.lng)) +
      "&t=" + Date.now();

    try {
      const r = await jsonp(url);
      if (r && r.ok) {
        setDot("ok");
        elBadge.textContent = "完了";
        setStatus([ r.message || "完了しました。", "Done.", "完成。", "완료." ]);
      } else {
        setDot("bad");
        elBadge.textContent = "エラー";
        if (r && r.code === "DENY_NEED_PROFILE") showOverlay(true);
        setStatus([ (r && r.message) ? r.message : "エラーが発生しました。", "Error.", "错误。", "오류." ]);
      }
    } catch(e) {
      setDot("bad");
      elBadge.textContent = "エラー";
      setStatus(["通信エラーまたはタイムアウトです。", "Network error/timeout.", "通信错误或超时。", "통신 오류/시간 초과."]);
    } finally {
      enableButtons(true);
    }
  }

  async function boot(){
    setDot("busy");
    elBadge.textContent = "起動中";
    setStatus(["準備しています...", "Preparing...", "准备中...", "준비 중..."]);
    enableButtons(false);

    const session = getSession();
    if (!session) {
      loginArea.style.display = "block";
      actionsArea.style.display = "none";
      setDot("ok");
      elBadge.textContent = "ログイン";
      setStatus(["最初にLINEでログインしてください。", "Please login with LINE.", "请先用LINE登录。", "먼저 LINE으로 로그인해 주세요."]);
      return;
    }

    loginArea.style.display = "none";
    actionsArea.style.display = "block";

    const ok = await ensureProfile(session);
    if (ok) {
      showOverlay(false);
      setDot("ok");
      elBadge.textContent = "準備OK";
      setStatus(["準備ができました。入店または退店を押してください。", "Ready. Tap Check in/out.", "准备就绪。请选择进入/离开。", "준비 완료. 입장/퇴장을 눌러 주세요."]);
      enableButtons(true);
    } else {
      setDot("warn");
      elBadge.textContent = "会員登録";
      setStatus(["初回のみ会員登録が必要です。", "One-time registration required.", "首次需要登记。", "최초 1회 등록이 필요합니다."]);
      enableButtons(false);
    }
  }

  btnLogin.addEventListener("click", () => {
    const url = GAS_WEBAPP_URL + "?action=login&return_url=" + encodeURIComponent(RETURN_URL);
    location.href = url;
  });

  btnSubmit.addEventListener("click", async () => {
    const session = getSession();
    if (!session) return;
    await submitProfile(session);
    await boot();
  });

  btnClose.addEventListener("click", () => showOverlay(false));

  btnIn.addEventListener("click", () => doCheck("check_in"));
  btnOut.addEventListener("click", () => doCheck("check_out"));

  boot();
</script>
</body>
</html>
