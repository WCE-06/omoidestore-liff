<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>COMPASSION WORLD 入店退店管理システム</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- ★ 応急処置：alert を完全に無効化（LIFF内で処理が止まるのを防ぐ） -->
  <script>
    window.alert = function(){};
    window.confirm = function(){ return true; };
    window.prompt = function(){ return null; };
  </script>

  <style>
    :root{
      --bg:#0b0f1a; --card:#121a2b; --text:#e7ecff; --muted:#aab6da;
      --good:#1db954; --warn:#f4c542; --bad:#ff5a6a;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 30% -10%, #1a2a6c33, transparent),
        radial-gradient(900px 500px at 120% 20%, #b21f1f22, transparent),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .app{ width:min(640px, 100%); }
    .card{
      background: linear-gradient(180deg, #141d33, var(--card));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 18px;
    }
    .header{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:12px;}
    .title{font-size:16px; margin:0; line-height:1.35;}
    .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); background:rgba(255,255,255,.04);}
    .status{border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04); border-radius:14px; padding:12px; margin:12px 0 16px;}
    .statusRow{display:flex; gap:10px;}
    .dot{width:10px; height:10px; border-radius:999px; margin-top:7px; background:var(--warn);}
    .i18n-ja{ font-size:15px; font-weight:650; }
    .i18n-sub div{ font-size:12px; color:var(--muted); }

    .actions{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    button{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:16px;
      padding:14px;
      cursor:pointer;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .btnIn{ background:linear-gradient(180deg, rgba(29,185,84,.22), rgba(255,255,255,.06)); }
    .btnOut{ background:linear-gradient(180deg, rgba(170,182,218,.14), rgba(255,255,255,.06)); }

    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      z-index:9999;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(560px,100%);
      border-radius:20px;
      background:#141d33;
      padding:16px;
    }
  </style>
</head>

<body>
<main class="app">
  <section class="card">
    <div class="header">
      <h1 class="title">COMPASSION WORLD 入店退店管理システム</h1>
      <div id="badge" class="badge">起動中</div>
    </div>

    <div class="status">
      <div class="statusRow">
        <div id="dot" class="dot"></div>
        <div>
          <div id="statusJa" class="i18n-ja">初期化中...</div>
          <div class="i18n-sub">
            <div id="statusEn">Initializing...</div>
            <div id="statusZh">正在初始化...</div>
            <div id="statusKo">초기화 중...</div>
          </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button id="btnIn" class="btnIn" disabled>入店</button>
      <button id="btnOut" class="btnOut" disabled>退店</button>
    </div>
  </section>
</main>

<script>
const LIFF_ID = "2008818718-xTQWF4uO";
const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbwHGto3ZK9UUETjdU3HJsqtW8pVhACN3H24DK_eBrRB8ubtDBHWANOFPpL1RdBBLdKQ/exec";

const elStatusJa = document.getElementById("statusJa");
const btnIn = document.getElementById("btnIn");
const btnOut = document.getElementById("btnOut");
const badge = document.getElementById("badge");

async function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    window[cb]=d=>{delete window[cb]; resolve(d);};
    const s=document.createElement("script");
    s.src=url+(url.includes("?")?"&":"?")+"callback="+cb;
    s.onerror=()=>reject();
    document.body.appendChild(s);
  });
}

async function call(action){
  const token=liff.getIDToken();
  const url=GAS_EXEC_URL+"?action="+action+"&id_token="+encodeURIComponent(token);
  const res=await jsonp(url);
  if(res.ok){
    elStatusJa.textContent=res.message;
  }else{
    elStatusJa.textContent=res.message||"エラー";
  }
}

async function init(){
  await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
  badge.textContent="準備OK";
  elStatusJa.textContent="準備ができました。";
  btnIn.disabled=false;
  btnOut.disabled=false;
}

btnIn.onclick=()=>call("in");
btnOut.onclick=()=>call("out");

init();
</script>
</body>
</html>
