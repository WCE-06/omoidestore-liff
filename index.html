<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>COMPASSION WORLD 入店退店管理システム</title>

  <style>
    :root{
      --bg:#0b0f1a; --card:#121a2b; --text:#e7ecff; --muted:#aab6da;
      --good:#1db954; --warn:#f4c542; --bad:#ff5a6a;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 18px;
      --ring: rgba(255,90,106,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 30% -10%, #1a2a6c33, transparent),
        radial-gradient(900px 500px at 120% 20%, #b21f1f22, transparent),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .app{ width:min(640px, 100%); }
    .card{
      background: linear-gradient(180deg, #141d33, var(--card));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 18px;
    }
    .header{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:12px;}
    .title{font-size:16px; margin:0; letter-spacing:.02em; line-height:1.35;}
    .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); background:rgba(255,255,255,.04); white-space:nowrap;}

    .status{border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04); border-radius:14px; padding:12px; margin:12px 0 16px;}
    .statusRow{display:flex; align-items:flex-start; gap:10px;}
    .dot{width:10px; height:10px; border-radius:999px; margin-top:7px; background:var(--warn); box-shadow:0 0 0 4px rgba(244,197,66,.18); flex:0 0 auto;}

    .i18nBlock{ line-height:1.45; }
    .i18n-ja{ font-size:15px; color:var(--text); font-weight:650; }
    .i18n-sub{ margin-top:6px; display:grid; gap:4px; }
    .i18n-sub div{ font-size:12px; color:var(--muted); }

    .actions{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    button{
      appearance:none; border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:16px;
      padding:14px 12px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      user-select:none;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnText{ text-align:center; }
    .btnText .ja{ font-size:16px; font-weight:750; }
    .btnText .sub{ margin-top:6px; display:grid; gap:4px; font-size:12px; color:var(--muted); line-height:1.2; }

    .btnIn{ border-color: rgba(29,185,84,.35); background: linear-gradient(180deg, rgba(29,185,84,.22), rgba(255,255,255,.06)); }
    .btnOut{ border-color: rgba(170,182,218,.25); background: linear-gradient(180deg, rgba(170,182,218,.14), rgba(255,255,255,.06)); }

    .footerNote{ margin-top:14px; color:var(--muted); font-size:12px; line-height:1.5; }

    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(560px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(20,29,51,.95), rgba(18,26,43,.95));
      box-shadow: var(--shadow);
      padding:16px;
      max-height: 88vh;
      overflow:auto;
    }
    .modalTop{ display:flex; align-items:center; gap:12px; justify-content:space-between; }
    .modalTitle{ margin:0; font-size:15px; }
    .pill{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); background:rgba(255,255,255,.04); white-space:nowrap; }
    .modalBody{ margin-top:10px; }

    .modalActions{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:14px; }
    .btnPrimary{ border-color: rgba(29,185,84,.35); background: linear-gradient(180deg, rgba(29,185,84,.22), rgba(255,255,255,.06)); }
    .btnGhost{ border-color: rgba(255,255,255,.16); background: rgba(255,255,255,.05); }

    .form{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .field{ display:grid; gap:6px; }
    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    label{ font-size:12px; color:var(--muted); }
    input, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:12px 12px;
      font-size:14px;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    textarea{ min-height: 90px; resize: vertical; }
    .invalid input, .invalid textarea{
      border-color: rgba(255,90,106,.75);
      box-shadow: 0 0 0 4px var(--ring);
    }
    .checkRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px;
    }
    .checkRow.invalid{
      border-color: rgba(255,90,106,.75);
      box-shadow: 0 0 0 4px var(--ring);
    }
    .checkRow input{ width:18px; height:18px; margin-top:2px; }
    .srOnly{
      position:absolute; width:1px; height:1px;
      padding:0; margin:-1px; overflow:hidden;
      clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }
    .linkBtn{
      display:inline-flex; align-items:center; justify-content:center;
      width:100%;
      text-decoration:none;
    }
  </style>
</head>

<body>
  <main class="app">
    <section class="card" aria-live="polite" aria-busy="false">
      <div class="header">
        <h1 class="title">COMPASSION WORLD 入店退店管理システム</h1>
        <div id="badge" class="badge">起動中</div>
      </div>

      <div class="status" role="status" aria-atomic="true">
        <div class="statusRow">
          <div id="dot" class="dot" aria-hidden="true"></div>
          <div class="i18nBlock">
            <div id="statusJa" class="i18n-ja">初期化中...</div>
            <div class="i18n-sub">
              <div id="statusEn">Initializing...</div>
              <div id="statusZh">正在初始化...</div>
              <div id="statusKo">초기화 중...</div>
            </div>
          </div>
        </div>
      </div>

      <div class="actions" id="actions">
        <button id="btnIn" class="btnIn" disabled>
          <div class="btnText">
            <div class="ja">入店</div>
            <div class="sub">
              <div>Check in</div>
              <div>进入</div>
              <div>입장</div>
            </div>
          </div>
        </button>

        <button id="btnOut" class="btnOut" disabled>
          <div class="btnText">
            <div class="ja">退店</div>
            <div class="sub">
              <div>Check out</div>
              <div>离开</div>
              <div>퇴장</div>
            </div>
          </div>
        </button>
      </div>

      <div class="footerNote">
        <div class="i18n-sub" style="margin-top:0;">
          <div id="footerJa">処理中はボタンが押せません。画面の案内に沿って操作してください。</div>
          <div>Buttons are disabled during processing. Please follow the on-screen instructions.</div>
          <div>处理过程中按钮不可用。请按照屏幕提示操作。</div>
          <div>처리 중에는 버튼을 사용할 수 없습니다. 화면 안내에 따라 주세요.</div>
        </div>
      </div>
    </section>
  </main>

  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalTop">
        <h2 id="modalTitle" class="modalTitle">確認</h2>
        <div id="modalPill" class="pill">案内</div>
      </div>

      <div class="modalBody">
        <div class="i18nBlock">
          <div id="modalJa" class="i18n-ja">確認中...</div>
          <div class="i18n-sub">
            <div id="modalEn">Checking...</div>
            <div id="modalZh">正在确认...</div>
            <div id="modalKo">확인 중...</div>
          </div>
        </div>

        <div id="modalForm" style="display:none;"></div>

        <div id="modalActions" class="modalActions">
          <button id="btnModalPrimary" class="btnPrimary" disabled>...</button>
          <button id="btnModalSecondary" class="btnGhost" disabled>...</button>
        </div>

        <div class="srOnly" id="srLive" aria-live="assertive"></div>
      </div>
    </div>
  </div>

<script>
  const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbzLQel89zRqO146wcLh2VWpPy9QOHKIl2rmffCgBfbutfru7CLBfQB3k-T44PnzgvY/exec";
  const APP_URL = "https://wce-06.github.io/omoidestore-liff/";

  const STORE_LAT = 35.9025210;
  const STORE_LNG = 138.4435135;
  const GEOFENCE_RADIUS_M = 50;

  const I18N = {
    init: ["初期化中...","Initializing...","正在初始化...","초기화 중..."],
    ready: ["準備ができました。入店または退店を押してください。","Ready. Tap Check in or Check out.","准备就绪。请选择进入或离开。","준비 완료. 입장 또는 퇴장을 눌러 주세요."],
    needLogin: ["ログインが必要です。","Login is required.","需要登录。","로그인이 필요합니다."],
    loginCta: ["LINEでログイン","Log in with LINE","使用LINE登录","LINE로 로그인"],
    loginNote: ["ログイン後、この画面に戻ります。","You'll return to this page after login.","登录后将返回此页面。","로그인 후 이 페이지로 돌아옵니다."],
    initFail: ["初期化に失敗しました。通信環境と設定を確認してください。","Initialization failed. Check network and settings.","初始化失败。请检查网络和设置。","초기화에 실패했습니다. 네트워크와 설정을 확인해 주세요."],
    netErr: ["通信エラーまたはタイムアウトです。電波状況を確認してお試しください。","Network error or timeout. Check your connection.","通信错误或超时。请检查网络。","통신 오류 또는 시간 초과. 네트워크를 확인해 주세요."],
    geoNeedHttps: ["位置情報の取得にはHTTPSが必要です。","Geolocation requires HTTPS.","定位需要HTTPS。","위치정보는 HTTPS가 필요합니다."],
    geoDenied: ["位置情報の利用が許可されていません。許可して再度お試しください。","Location permission denied. Please allow and retry.","未允许定位权限。请允许后重试。","위치 권한이 거부되었습니다. 허용 후 다시 시도해 주세요."],
    geoOut: ["店舗付近でのみ操作できます。","You can operate only near the store.","仅限在店铺附近操作。","매장 근처에서만 조작할 수 있습니다."],
    confirmIn: { title:"確認", pill:"入店",
      body:["入店を記録します。よろしいですか。","You are about to check in. Continue?","将记录进入。继续吗？","입장을 기록합니다. 진행할까요?"],
      primary:"入店する", secondary:"やめる"
    },
    confirmOut: { title:"確認", pill:"退店",
      body:["退店を記録します。よろしいですか。","You are about to check out. Continue?","将记录离开。继续吗？","퇴장을 기록합니다. 진행할까요?"],
      primary:"退店する", secondary:"やめる"
    },
    profileGate: {
      title:"会員情報の登録", pill:"初回のみ",
      lead:[
        "COMPASSION WORLDが平和で心地よい世界であり続けるために",
        "To keep COMPASSION WORLD peaceful and welcoming, we ask for a one-time registration.",
        "为了让COMPASSION WORLD保持和平舒适，我们需要一次性注册。",
        "COMPASSION WORLD가 평화롭고 편안한 세계로 유지되기 위해 1회 등록이 필요합니다."
      ]
    }
  };

  const elBadge = document.getElementById("badge");
  const elDot = document.getElementById("dot");
  const elStatusJa = document.getElementById("statusJa");
  const elStatusEn = document.getElementById("statusEn");
  const elStatusZh = document.getElementById("statusZh");
  const elStatusKo = document.getElementById("statusKo");
  const btnIn = document.getElementById("btnIn");
  const btnOut = document.getElementById("btnOut");
  const actions = document.getElementById("actions");
  const card = document.querySelector(".card");

  const overlay = document.getElementById("overlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalPill = document.getElementById("modalPill");
  const modalJa = document.getElementById("modalJa");
  const modalEn = document.getElementById("modalEn");
  const modalZh = document.getElementById("modalZh");
  const modalKo = document.getElementById("modalKo");
  const modalForm = document.getElementById("modalForm");
  const btnModalPrimary = document.getElementById("btnModalPrimary");
  const btnModalSecondary = document.getElementById("btnModalSecondary");
  const srLive = document.getElementById("srLive");

  function setDot(state){
    if (state === "ok") { elDot.style.background = "var(--good)"; elDot.style.boxShadow = "0 0 0 4px rgba(29,185,84,.18)"; return; }
    if (state === "busy") { elDot.style.background = "var(--warn)"; elDot.style.boxShadow = "0 0 0 4px rgba(244,197,66,.18)"; return; }
    if (state === "error") { elDot.style.background = "var(--bad)"; elDot.style.boxShadow = "0 0 0 4px rgba(255,90,106,.18)"; return; }
  }
  function setStatusLines(lines){
    elStatusJa.textContent = lines[0] || "";
    elStatusEn.textContent = lines[1] || "";
    elStatusZh.textContent = lines[2] || "";
    elStatusKo.textContent = lines[3] || "";
    srLive.textContent = lines[0] || "";
  }
  function enableButtons(ready){
    btnIn.disabled = !ready;
    btnOut.disabled = !ready;
  }
  function showOverlay(show){
    overlay.classList.toggle("show", !!show);
    overlay.setAttribute("aria-hidden", show ? "false" : "true");
  }
  function setBusy(on){
    card.setAttribute("aria-busy", on ? "true" : "false");
    enableButtons(!on);
  }
  function setModal(cfg){
    modalTitle.textContent = cfg.title || "";
    modalPill.textContent = cfg.pill || "";
    modalJa.textContent = (cfg.body && cfg.body[0]) || "";
    modalEn.textContent = (cfg.body && cfg.body[1]) || "";
    modalZh.textContent = (cfg.body && cfg.body[2]) || "";
    modalKo.textContent = (cfg.body && cfg.body[3]) || "";
    srLive.textContent = (cfg.body && cfg.body[0]) || "";
    modalForm.style.display = "none";
    modalForm.innerHTML = "";
    btnModalPrimary.textContent = cfg.primary || "";
    btnModalSecondary.textContent = cfg.secondary || "";
    btnModalPrimary.disabled = false;
    btnModalSecondary.disabled = false;
  }

  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      window[cb] = (data) => { cleanup(); resolve(data); };

      const script = document.createElement("script");
      const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, 20000);

      function cleanup() {
        clearTimeout(timer);
        if (script.parentNode) script.parentNode.removeChild(script);
        delete window[cb];
      }

      const sep = url.includes("?") ? "&" : "?";
      script.src = url + sep + "callback=" + encodeURIComponent(cb);
      script.onerror = () => { cleanup(); reject(new Error("load error")); };
      document.body.appendChild(script);
    });
  }

  function getSessionFromHash(){
    const m = (location.hash || "").match(/(?:^|[&#])session=([^&]+)/);
    return m ? decodeURIComponent(m[1]) : "";
  }
  function saveSession(s){
    if (!s) return;
    localStorage.setItem("cw_session", s);
  }
  function loadSession(){
    return localStorage.getItem("cw_session") || "";
  }
  function clearSession(){
    localStorage.removeItem("cw_session");
  }

  function loginStartUrl(){
    const u = new URL(GAS_EXEC_URL);
    u.searchParams.set("action","login");
    u.searchParams.set("return_url", APP_URL);
    return u.toString();
  }

  async function api(op, params={}){
    const session = loadSession();
    const u = new URL(GAS_EXEC_URL);
    u.searchParams.set("action","api");
    u.searchParams.set("op", op);
    u.searchParams.set("session", session);
    u.searchParams.set("t", String(Date.now()));
    for (const [k,v] of Object.entries(params)){
      u.searchParams.set(k, String(v));
    }
    return await jsonp(u.toString());
  }

  function showLoginGate(){
    showOverlay(true);
    modalTitle.textContent = "ログイン";
    modalPill.textContent = "LINE";
    modalJa.textContent = I18N.needLogin[0];
    modalEn.textContent = I18N.needLogin[1];
    modalZh.textContent = I18N.needLogin[2];
    modalKo.textContent = I18N.needLogin[3];

    modalForm.style.display = "block";
    modalForm.innerHTML = `
      <div class="i18n-sub" style="margin-top:10px;">
        <div>${I18N.loginNote[0]}</div>
        <div>${I18N.loginNote[1]}</div>
        <div>${I18N.loginNote[2]}</div>
        <div>${I18N.loginNote[3]}</div>
      </div>
    `;

    btnModalPrimary.textContent = I18N.loginCta[0];
    btnModalSecondary.textContent = "閉じる";
    btnModalPrimary.disabled = false;
    btnModalSecondary.disabled = false;

    btnModalPrimary.onclick = () => {
      location.href = loginStartUrl();
    };
    btnModalSecondary.onclick = () => {
      showOverlay(false);
      enableButtons(false);
    };
  }

  async function gateFlow(){
    enableButtons(false);
    elBadge.textContent = "準備中";
    setDot("busy");

    const session = loadSession();
    if (!session){
      setDot("error");
      setStatusLines(I18N.needLogin);
      showLoginGate();
      return;
    }

    let st;
    try{
      st = await api("profile_status");
    }catch(e){
      setDot("error");
      setStatusLines(I18N.netErr);
      showLoginGate();
      return;
    }

    if (st && st.ok === false && (String(st.message || "").includes("認証") || String(st.message || "").includes("期限"))){
      clearSession();
      setDot("error");
      setStatusLines(I18N.needLogin);
      showLoginGate();
      return;
    }

    if (!(st && st.ok && st.has_profile)){
      showOverlay(true);
      renderProfileForm();
      return;
    }

    showOverlay(false);
    elBadge.textContent = "準備OK";
    setDot("ok");
    setStatusLines(I18N.ready);
    enableButtons(true);
  }

  function markInvalid(map){
    for (const k of Object.keys(map)){
      const wrap = document.getElementById("wrap_" + k);
      if (!wrap) continue;
      wrap.classList.toggle("invalid", !!map[k]);
    }
    const consentWrap = document.getElementById("wrap_consent");
    if (consentWrap && map.consent) consentWrap.classList.add("invalid");
  }

  function renderProfileForm(){
    modalTitle.textContent = I18N.profileGate.title;
    modalPill.textContent = I18N.profileGate.pill;

    modalJa.textContent = I18N.profileGate.lead[0];
    modalEn.textContent = I18N.profileGate.lead[1];
    modalZh.textContent = I18N.profileGate.lead[2];
    modalKo.textContent = I18N.profileGate.lead[3];

    btnModalPrimary.textContent = "登録を送信";
    btnModalSecondary.textContent = "閉じる";
    btnModalPrimary.disabled = false;
    btnModalSecondary.disabled = false;

    modalForm.style.display = "block";
    modalForm.innerHTML = `
      <div class="i18n-sub" style="margin-top:10px;">
        <div>
          COMPASSION WORLDは、訪れるすべての方が安心して過ごせる平和であたたかな世界であることを大切にしています。<br>
          その世界を守り続けるため、初めてご利用いただく際のみ、会員登録へのご協力をお願いしています。<br>
          ご登録後は、入店・退店の操作のみでスムーズにご利用いただけます。
        </div>
      </div>

      <div class="form">
        <div class="row2">
          <div id="wrap_last_name" class="field">
            <label>姓</label>
            <input id="f_last_name" type="text" placeholder="例 上田" autocomplete="family-name" />
          </div>
          <div id="wrap_first_name" class="field">
            <label>名</label>
            <input id="f_first_name" type="text" placeholder="例 歩夢" autocomplete="given-name" />
          </div>
        </div>

        <div class="row2">
          <div id="wrap_last_kana" class="field">
            <label>姓（カナ）</label>
            <input id="f_last_kana" type="text" placeholder="例 ウエダ" />
          </div>
          <div id="wrap_first_kana" class="field">
            <label>名（カナ）</label>
            <input id="f_first_kana" type="text" placeholder="例 アユム" />
          </div>
        </div>

        <div id="wrap_phone" class="field">
          <label>電話番号</label>
          <input id="f_phone" type="tel" placeholder="例 09012345678" autocomplete="tel" />
        </div>

        <div id="wrap_address" class="field">
          <label>住所</label>
          <textarea id="f_address" placeholder="例 山梨県北杜市..."></textarea>
        </div>

        <div id="wrap_consent" class="checkRow">
          <input id="f_consent" type="checkbox" />
          <div>
            本システムが、COMPASSION WORLDの平和な世界を守るために利用されることに同意します
            <div class="i18n-sub" style="margin-top:6px;">
              <div>I agree this system is used to keep COMPASSION WORLD peaceful and welcoming.</div>
              <div>我同意本系统用于守护COMPASSION WORLD的和平与舒适。</div>
              <div>본 시스템이 COMPASSION WORLD의 평화로운 세계를 지키기 위해 사용됨에 동의합니다.</div>
            </div>
          </div>
        </div>
      </div>
    `;

    btnModalPrimary.onclick = async () => {
      window.scrollTo({ top: 0, behavior: "smooth" });

      const payload = {
        last_name: document.getElementById("f_last_name").value.trim(),
        first_name: document.getElementById("f_first_name").value.trim(),
        last_kana: document.getElementById("f_last_kana").value.trim(),
        first_kana: document.getElementById("f_first_kana").value.trim(),
        phone: document.getElementById("f_phone").value.trim(),
        address: document.getElementById("f_address").value.trim(),
        consent: document.getElementById("f_consent").checked
      };

      const missingMap = {
        last_name: !payload.last_name,
        first_name: !payload.first_name,
        last_kana: !payload.last_kana,
        first_kana: !payload.first_kana,
        phone: !payload.phone,
        address: !payload.address,
        consent: !payload.consent
      };
      markInvalid(missingMap);

      if (Object.values(missingMap).some(Boolean)){
        setDot("error");
        setStatusLines([
          "未入力の項目があります。赤く表示された箇所を確認してください。",
          "Some fields are missing. Check the highlighted fields.",
          "有未填写项目。请检查红色标记处。",
          "미입력 항목이 있습니다. 빨간 표시를 확인해 주세요."
        ]);
        return;
      }

      setBusy(true);
      elBadge.textContent = "送信中";
      setDot("busy");

      try{
        const res = await api("profile_set", payload);
        if (res && res.ok){
          setDot("ok");
          setStatusLines([
            "登録が完了しました。入店または退店を押してください。",
            "Registration completed. Tap Check in or Check out.",
            "登记完成。请选择进入或离开。",
            "등록 완료. 입장 또는 퇴장을 눌러 주세요."
          ]);
          showOverlay(false);
          await gateFlow();
        }else{
          if (res && res.code === "MISSING" && Array.isArray(res.missing)){
            const mm = {};
            res.missing.forEach(k => mm[k] = true);
            markInvalid(mm);
            setDot("error");
            setStatusLines([
              "未入力の項目があります。赤く表示された箇所を確認してください。",
              "Some fields are missing. Check the highlighted fields.",
              "有未填写项目。请检查红色标记处。",
              "미입력 항목이 있습니다. 빨간 표시를 확인해 주세요."
            ]);
            return;
          }
          setDot("error");
          setStatusLines([
            (res && res.message) ? String(res.message) : "登録に失敗しました。もう一度お試しください。",
            "Registration failed. Please try again.",
            "登记失败。请重试。",
            "등록에 실패했습니다. 다시 시도해 주세요."
          ]);
        }
      }catch(e){
        setDot("error");
        setStatusLines(I18N.netErr);
      }finally{
        setBusy(false);
        elBadge.textContent = "準備中";
      }
    };

    btnModalSecondary.onclick = () => {
      showOverlay(false);
      setDot("error");
      setStatusLines([
        "会員情報の登録が完了していないため、入店退店はできません。",
        "You can't proceed without registration.",
        "未完成登记，无法继续。",
        "등록이 완료되지 않아 진행할 수 없습니다."
      ]);
      enableButtons(false);
    };
  }

  function distanceMeters(lat1,lng1,lat2,lng2){
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function getGeo(){
    return new Promise((resolve, reject) => {
      if (!window.isSecureContext){
        reject(new Error("insecure"));
        return;
      }
      if (!navigator.geolocation){
        reject(new Error("no geo"));
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
        err => reject(err),
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
      );
    });
  }

  async function callCheck(op){
    setBusy(true);
    elBadge.textContent = "処理中";
    setDot("busy");
    setStatusLines(["通信中です。しばらくお待ちください。","Communicating... Please wait.","正在通信…请稍候。","통신 중입니다. 잠시만 기다려 주세요."]);

    let geo;
    try{
      geo = await getGeo();
    }catch(e){
      setBusy(false);
      elBadge.textContent = "エラー";
      setDot("error");
      if (String(e && e.message) === "insecure"){
        setStatusLines(I18N.geoNeedHttps);
      }else if (e && typeof e.code === "number"){
        setStatusLines(I18N.geoDenied);
      }else{
        setStatusLines(I18N.netErr);
      }
      return;
    }

    const d = distanceMeters(STORE_LAT, STORE_LNG, geo.lat, geo.lng);
    if (d > GEOFENCE_RADIUS_M){
      setBusy(false);
      elBadge.textContent = "エラー";
      setDot("error");
      setStatusLines(I18N.geoOut);
      return;
    }

    try{
      const res = await api(op === "in" ? "check_in" : "check_out", { lat: geo.lat, lng: geo.lng });
      if (res && res.ok){
        elBadge.textContent = "完了";
        setDot("ok");
        const ja = res.message || "完了しました。";
        setStatusLines([
          ja,
          "Done.",
          "完成。",
          "완료."
        ]);
      }else{
        if (res && res.code === "DENY_NEED_PROFILE"){
          showOverlay(true);
          renderProfileForm();
          return;
        }
        if (res && (String(res.message || "").includes("認証") || String(res.message || "").includes("期限"))){
          clearSession();
          showLoginGate();
          return;
        }
        elBadge.textContent = "エラー";
        setDot("error");
        setStatusLines([
          (res && res.message) ? String(res.message) : "エラーが発生しました。もう一度お試しください。",
          "An error occurred. Please try again.",
          "发生错误。请重试。",
          "오류가 발생했습니다. 다시 시도해 주세요."
        ]);
      }
    }catch(e){
      elBadge.textContent = "エラー";
      setDot("error");
      setStatusLines(I18N.netErr);
    }finally{
      setBusy(false);
    }
  }

  function openConfirm(action){
    showOverlay(true);
    enableButtons(false);

    const cfg = action === "in" ? I18N.confirmIn : I18N.confirmOut;
    setModal(cfg);

    btnModalPrimary.onclick = async () => {
      showOverlay(false);
      enableButtons(false);
      await callCheck(action);
      enableButtons(true);
    };
    btnModalSecondary.onclick = () => {
      showOverlay(false);
      enableButtons(true);
    };
  }

  async function init(){
    elBadge.textContent = "起動中";
    setDot("busy");
    setStatusLines(I18N.init);
    enableButtons(false);

    const s = getSessionFromHash();
    if (s){
      saveSession(s);
      history.replaceState(null, "", location.pathname + location.search);
    }

    await gateFlow();
  }

  btnIn.addEventListener("click", () => openConfirm("in"));
  btnOut.addEventListener("click", () => openConfirm("out"));

  document.addEventListener("visibilitychange", async () => {
    if (document.visibilityState === "visible") {
      await gateFlow();
    }
  });

  init();
</script>
</body>
</html>
