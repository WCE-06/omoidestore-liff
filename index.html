<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>おもいで商店 入退店</title>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  </head>
  <body>
    <h2 id="status">初期化中...</h2>

    <button id="btnIn" disabled>入店</button>
    <button id="btnOut" disabled>退店</button>

    <script>
      // ===== 設定 =====
      const LIFF_ID = "2008818718-xTQWF4uO";

      // ★ dev ではなく exec を使う ★
      const GAS_EXEC_URL =
        "https://script.google.com/macros/s/AKfycbz349Qb4iJCwTjJge3qow4BY8YvMQXXfO80V0iQvNXARIFAafT_AberzQLitmD__PZBXg/exec"

      // ★ GAS側と完全一致させる ★
      const SHARED_KEY = "omoidestore_2026_01_key_9h3f2k";

      // =================

      function setStatus(msg) {
        document.getElementById("status").textContent = msg;
      }

      function enableButtons(f) {
        document.getElementById("btnIn").disabled = !f;
        document.getElementById("btnOut").disabled = !f;
      }

      function jsonp(url) {
        return new Promise((resolve, reject) => {
          const cb = "cb_" + Math.random().toString(36).slice(2);
          window[cb] = (data) => {
            cleanup();
            resolve(data);
          };

          const script = document.createElement("script");
          const timer = setTimeout(() => {
            cleanup();
            reject(new Error("timeout"));
          }, 15000);

          function cleanup() {
            clearTimeout(timer);
            if (script.parentNode) script.parentNode.removeChild(script);
            delete window[cb];
          }

          const sep = url.includes("?") ? "&" : "?";
          script.src = url + sep + "callback=" + encodeURIComponent(cb);
          script.onerror = () => {
            cleanup();
            reject(new Error("load error"));
          };

          document.body.appendChild(script);
        });
      }

      async function init() {
        try {
          await liff.init({
            liffId: LIFF_ID,
            withLoginOnExternalBrowser: true
          });
          setStatus("準備OK。入店または退店を押してください。");
          enableButtons(true);
        } catch (e) {
          setStatus("LIFF初期化エラー（Endpoint URLを確認）");
        }
      }

      async function callGAS(action) {
        enableButtons(false);
        setStatus(action === "in" ? "入店処理中..." : "退店処理中...");

        try {
          const url =
            GAS_EXEC_URL +
            "?action=" + encodeURIComponent(action) +
            "&k=" + encodeURIComponent(SHARED_KEY) +
            "&t=" + Date.now();

          const res = await jsonp(url);
          setStatus(res.message || "完了");
        } catch (e) {
          setStatus("通信エラーまたはタイムアウト");
        } finally {
          enableButtons(true);
        }
      }

      document.getElementById("btnIn").onclick = () => callGAS("in");
      document.getElementById("btnOut").onclick = () => callGAS("out");

      init();
    </script>
  </body>
</html>
