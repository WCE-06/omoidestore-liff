<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>COMPASSION WORLD 入店退店管理システム</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  :root{
    --bg:#0b0f1a; --card:#121a2b; --text:#e7ecff; --muted:#aab6da;
    --good:#1db954; --warn:#f4c542; --bad:#ff5a6a;
    --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
    padding:16px; background:var(--bg); color:var(--text);
    font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;
  }
  .wrap{width:min(720px,100%)}
  .card{
    background:linear-gradient(180deg,#141d33,var(--card));
    border:1px solid rgba(255,255,255,.08);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:18px;
  }
  .header{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:12px;}
  .title{margin:0; font-size:16px; line-height:1.35;}
  .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); background:rgba(255,255,255,.04); white-space:nowrap;}

  .status{
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    border-radius:14px;
    padding:12px;
    margin:12px 0 16px;
  }
  .statusRow{display:flex; gap:10px; align-items:flex-start;}
  .dot{width:10px; height:10px; border-radius:999px; margin-top:7px; background:var(--warn); box-shadow:0 0 0 4px rgba(244,197,66,.18);}
  .i18n-ja{font-size:15px; font-weight:650; color:var(--text);}
  .i18n-sub{margin-top:6px; display:grid; gap:4px;}
  .i18n-sub div{font-size:12px; color:var(--muted);}

  .panel{display:none;}
  .panel.show{display:block;}

  .notice{
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    padding:12px;
    margin-bottom:12px;
    line-height:1.6;
  }
  .noticeTitle{
    font-size:14px;
    color:var(--text);
    font-weight:650;
    white-space: pre-line;
  }
  .noticeBody{
    font-size:12px;
    color:var(--muted);
    margin-top:8px;
    white-space: pre-line;
  }

  form{margin:0}
  .form{display:grid; gap:10px;}
  .field{display:grid; gap:6px;}
  label{font-size:12px; color:var(--muted);}
  input, textarea{
    width:100%;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(0,0,0,.18);
    color:var(--text);
    padding:12px 12px;
    font-size:14px;
    outline:none;
  }
  textarea{min-height:90px; resize:vertical;}
  .nameGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px;}

  .agreeRow{
    display:flex;
    gap:10px;
    align-items:flex-start;
    line-height:1.5;
    color:var(--muted);
    font-size:12px;
    margin-top:8px;
    padding:8px 10px;
    border-radius:14px;
    border:1px solid transparent;
  }
  .agreeRow input{width:18px; height:18px; margin-top:2px;}
  .agreeText{flex:1;}
  .linkBtn{
    display:inline-block;
    color:var(--text);
    text-decoration:underline;
    text-underline-offset:3px;
    cursor:pointer;
  }

  .actions{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;}
  button{
    appearance:none;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    color:var(--text);
    border-radius:16px;
    padding:14px 12px;
    cursor:pointer;
  }
  button:disabled{opacity:.55; cursor:not-allowed;}

  .btnPrimary{border-color: rgba(29,185,84,.35); background: linear-gradient(180deg, rgba(29,185,84,.22), rgba(255,255,255,.06));}
  .btnIn{border-color: rgba(29,185,84,.35); background: linear-gradient(180deg, rgba(29,185,84,.22), rgba(255,255,255,.06));}
  .btnOut{border-color: rgba(170,182,218,.25); background: linear-gradient(180deg, rgba(170,182,218,.14), rgba(255,255,255,.06));}

  .overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
    display:none;
    align-items:center; justify-content:center;
    padding:18px;
    z-index:9999;
  }
  .overlay.show{display:flex;}
  .modal{
    width:min(760px, 100%);
    border-radius:20px;
    border:1px solid rgba(255,255,255,.14);
    background:linear-gradient(180deg, rgba(20,29,51,.95), rgba(18,26,43,.95));
    box-shadow:var(--shadow);
    padding:16px;
  }
  .modalTop{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
  .modalTitle{margin:0; font-size:15px;}
  .modalBody{margin-top:10px;}

  .termsBox{
    max-height:52vh;
    overflow:auto;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.18);
    padding:12px;
  }
  .termsText{
    white-space: pre-wrap;
    font-size:12px;
    line-height:1.7;
    color:var(--text);
  }
  .termsHint{margin-top:10px; font-size:12px; color:var(--muted);}

  .modalActions{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:14px;}
  .badgeSmall{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); background:rgba(255,255,255,.04); white-space:nowrap;}

  .srOnly{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;}

  .errField{
    border-color: rgba(255,90,106,.9) !important;
    box-shadow: 0 0 0 4px rgba(255,90,106,.20) !important;
  }
  .errRow{
    border-color: rgba(255,90,106,.9) !important;
    background: rgba(255,90,106,.10) !important;
  }
</style>
</head>

<body>
<main class="wrap">
  <section class="card" aria-live="polite" aria-busy="false">
    <div class="header">
      <h1 class="title">COMPASSION WORLD 入店退店管理システム</h1>
      <div id="badge" class="badge">起動中</div>
    </div>

    <div class="status" role="status" aria-atomic="true">
      <div class="statusRow">
        <div id="dot" class="dot" aria-hidden="true"></div>
        <div>
          <div id="statusJa" class="i18n-ja">初期化中...</div>
          <div class="i18n-sub">
            <div id="statusEn">Initializing...</div>
            <div id="statusZh">正在初始化...</div>
            <div id="statusKo">초기화 중...</div>
          </div>
        </div>
      </div>
    </div>

    <div id="panelRegister" class="panel">
      <div class="notice">
        <div class="noticeTitle">COMPASSION WORLDが
平和で心地よい世界であり続けるために</div>
        <div class="noticeBody">COMPASSION WORLDは、
訪れるすべての方が安心して過ごせる
平和であたたかな世界であることを大切にしています。
その世界を守り続けるため、
初めてご利用いただく際のみ、
会員登録へのご協力をお願いしています。
ご登録後は、入店・退店の操作のみで
スムーズにご利用いただけます。</div>
        <div class="i18n-sub" style="margin-top:8px;">
          <div>To keep COMPASSION WORLD peaceful and welcoming, we ask for a one-time registration.</div>
          <div>为保持COMPASSION WORLD平和舒适，首次使用需完成一次登记，感谢配合。</div>
          <div>COMPASSION WORLD가 평화롭고 편안한 곳으로 유지될 수 있도록 최초 1회 등록에 협조 부탁드립니다.</div>
        </div>
      </div>

      <form id="regForm" novalidate>
        <div class="form">
          <div class="nameGrid">
            <div class="field">
              <label>姓</label>
              <input id="f_sei" type="text" autocomplete="family-name" required />
            </div>
            <div class="field">
              <label>名</label>
              <input id="f_mei" type="text" autocomplete="given-name" required />
            </div>
          </div>

          <div class="nameGrid">
            <div class="field">
              <label>姓（カナ）</label>
              <input id="f_sei_kana" type="text" inputmode="kana" required />
            </div>
            <div class="field">
              <label>名（カナ）</label>
              <input id="f_mei_kana" type="text" inputmode="kana" required />
            </div>
          </div>

          <div class="field">
            <label>電話番号</label>
            <input id="f_phone" type="tel" autocomplete="tel" required />
          </div>

          <div class="field">
            <label>住所</label>
            <textarea id="f_address" autocomplete="street-address" required></textarea>
          </div>

          <div id="rowAgreeGate" class="agreeRow">
            <input id="f_agree_gate" type="checkbox" disabled />
            <div class="agreeText">
              <div>
                <span id="openTerms" class="linkBtn" role="button" tabindex="0">利用規約を確認する</span>
                を開いて最後までスクロールすると、同意チェックが有効になります。
              </div>
              <div class="i18n-sub" style="margin-top:6px;">
                <div>Open the Terms and scroll to the bottom to enable consent.</div>
                <div>打开条款并滚动到底部以启用同意。</div>
                <div>약관을 열고 끝까지 스크롤하면 동의가 활성화됩니다.</div>
              </div>
            </div>
          </div>

          <div id="rowConsent" class="agreeRow" style="margin-top:6px;">
            <input id="f_consent" type="checkbox" disabled required />
            <div class="agreeText">
              本システムが、
              COMPASSION WORLDの平和な世界を守るために
              利用されることに同意します
              <div class="i18n-sub" style="margin-top:6px;">
                <div>I agree this system is used to keep COMPASSION WORLD peaceful and welcoming.</div>
                <div>我同意本系统用于守护COMPASSION WORLD的平和与舒适。</div>
                <div>본 시스템이 COMPASSION WORLD의 평화로운 환경을 지키기 위해 사용됨에 동의합니다.</div>
              </div>
            </div>
          </div>

          <div class="actions">
            <button id="btnRegSubmit" class="btnPrimary" type="button" disabled>登録を送信</button>
            <button id="btnRegCancel" type="button" disabled>閉じる</button>
          </div>
        </div>
      </form>
    </div>

    <div id="panelActions" class="panel">
      <div class="actions">
        <button id="btnIn" class="btnIn" disabled type="button">入店</button>
        <button id="btnOut" class="btnOut" disabled type="button">退店</button>
      </div>
      <div class="i18n-sub" style="margin-top:10px;">
        <div>Check in / Check out</div>
        <div>进入 / 离开</div>
        <div>입장 / 퇴장</div>
      </div>
    </div>

    <div class="srOnly" id="srLive" aria-live="assertive"></div>
  </section>
</main>

<div id="overlay" class="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalTop">
      <div>
        <h2 id="modalTitle" class="modalTitle">利用規約</h2>
        <div class="i18n-sub"><div>Terms of Use</div><div>使用条款</div><div>이용 약관</div></div>
      </div>
      <div id="modalBadge" class="badgeSmall">確認してください</div>
    </div>

    <div class="modalBody">
      <div id="termsBox" class="termsBox">
        <div id="termsText" class="termsText"></div>
      </div>
      <div class="termsHint" id="termsHint">最後までスクロールすると同意チェックが有効になります。</div>

      <div class="modalActions">
        <button id="btnCloseTerms" type="button">閉じる</button>
        <button id="btnAcknowledge" class="btnPrimary" type="button" disabled>確認しました</button>
      </div>
    </div>
  </div>
</div>

<script>
  const LIFF_ID = "2008818718-xTQWF4uO";
  const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbzY8ZYm-telsuItGezTE1H6rEfo2Z3QcrOb9YMNA_e7coHwoAYzjXFtFU_mWOJE9TmS/exec";

  const TERMS_VERSION = "Ver.1.0 / 2026-01-10";
  const TERMS_TEXT =
`COMPASSION WORLD 入店退店管理システム
会員利用規約（${TERMS_VERSION}）

第1条 目的
本規約は、COMPASSION WORLD 入店退店管理システムを利用するすべての利用者に対し、施設の安全な運営、緊急時の連絡を目的として、会員情報の取得および利用条件を定めるものです。

第2条 会員登録
本システムを利用して入店または退店を行う場合、初回利用時に以下の会員情報の登録が必要となります。
・姓
・名
・姓（カナ）
・名（カナ）
・住所
・電話番号
利用者は、正確かつ最新の情報を登録するものとします。

第3条 個人情報の利用目的
取得した個人情報は、以下の目的の範囲内で利用します。
・施設の入退店履歴の管理
・緊急時における利用者への連絡
・安心して過ごせる環境づくりのための確認
・法令に基づく対応および手続

第4条 店内備品等の破損・汚損
利用者の故意または過失、または通常の使用方法を超える利用により、店内備品、設備、商品、建物その他の物品に破損、汚損、紛失等の損害が生じた場合、当施設は、修理または交換に要する合理的な実費相当額を請求できるものとし、利用者はこれを負担します。
通常の利用による経年劣化、通常損耗に該当するものは、原則として請求の対象外とします。

第5条 個人情報の管理
取得した個人情報は、漏えい、紛失、改ざん等を防止するため、適切な安全管理措置を講じて管理します。

第6条 個人情報の第三者提供
以下の場合を除き、本人の同意なく第三者に提供することはありません。
・法令に基づく場合
・警察、裁判所等の公的機関から正当な要請を受けた場合
・利用者または第三者の生命、身体、財産の保護のために必要な場合

第7条 入店退店の制限
会員登録が完了していない場合、または虚偽の情報が登録されていると判断された場合、本システムによる入店および退店をお断りすることがあります。

第8条 規約の変更
本規約は、必要に応じて予告なく変更されることがあります。変更後の規約は、本システム上に表示された時点で効力を生じます。

第9条 同意の成立
本規約は、利用者が規約内容を確認し、同意の意思表示を行ったうえで会員登録を送信した時点で成立するものとします。`;

  const elBadge = document.getElementById("badge");
  const elDot = document.getElementById("dot");
  const elStatusJa = document.getElementById("statusJa");
  const elStatusEn = document.getElementById("statusEn");
  const elStatusZh = document.getElementById("statusZh");
  const elStatusKo = document.getElementById("statusKo");
  const srLive = document.getElementById("srLive");

  const panelRegister = document.getElementById("panelRegister");
  const panelActions = document.getElementById("panelActions");

  const overlay = document.getElementById("overlay");
  const termsBox = document.getElementById("termsBox");
  const termsText = document.getElementById("termsText");
  const termsHint = document.getElementById("termsHint");
  const modalBadge = document.getElementById("modalBadge");
  const btnCloseTerms = document.getElementById("btnCloseTerms");
  const btnAcknowledge = document.getElementById("btnAcknowledge");

  const btnRegSubmit = document.getElementById("btnRegSubmit");
  const btnRegCancel = document.getElementById("btnRegCancel");
  const btnIn = document.getElementById("btnIn");
  const btnOut = document.getElementById("btnOut");

  const rowAgreeGate = document.getElementById("rowAgreeGate");
  const rowConsent = document.getElementById("rowConsent");

  const f = {
    sei: document.getElementById("f_sei"),
    mei: document.getElementById("f_mei"),
    seiKana: document.getElementById("f_sei_kana"),
    meiKana: document.getElementById("f_mei_kana"),
    phone: document.getElementById("f_phone"),
    address: document.getElementById("f_address"),
    agreeGate: document.getElementById("f_agree_gate"),
    consent: document.getElementById("f_consent"),
  };

  let termsOpenedOnce = false;
  let termsScrolledToBottom = false;

  function setDot(state){
    if (state === "ok") { elDot.style.background = "var(--good)"; elDot.style.boxShadow = "0 0 0 4px rgba(29,185,84,.18)"; return; }
    if (state === "busy") { elDot.style.background = "var(--warn)"; elDot.style.boxShadow = "0 0 0 4px rgba(244,197,66,.18)"; return; }
    elDot.style.background = "var(--bad)"; elDot.style.boxShadow = "0 0 0 4px rgba(255,90,106,.18)";
  }

  function setStatus(ja,en,zh,ko){
    elStatusJa.textContent = ja || "";
    elStatusEn.textContent = en || "";
    elStatusZh.textContent = zh || "";
    elStatusKo.textContent = ko || "";
    srLive.textContent = ja || "";
  }

  function showOverlay(show){
    overlay.classList.toggle("show", !!show);
    overlay.setAttribute("aria-hidden", show ? "false" : "true");
  }

  function showRegister(){
    panelRegister.classList.add("show");
    panelActions.classList.remove("show");
  }

  function showActions(){
    panelRegister.classList.remove("show");
    panelActions.classList.add("show");
  }

  function setBusy(on){
    document.querySelector(".card").setAttribute("aria-busy", on ? "true" : "false");
  }

  function clearErrors(){
    Object.values(f).forEach(el => el.classList.remove("errField"));
    rowAgreeGate.classList.remove("errRow");
    rowConsent.classList.remove("errRow");
  }

  function markMissing(keys){
    clearErrors();
    const set = new Set((keys || []).map(String));
    if (set.has("sei")) f.sei.classList.add("errField");
    if (set.has("mei")) f.mei.classList.add("errField");
    if (set.has("sei_kana")) f.seiKana.classList.add("errField");
    if (set.has("mei_kana")) f.meiKana.classList.add("errField");
    if (set.has("phone")) f.phone.classList.add("errField");
    if (set.has("address")) f.address.classList.add("errField");
    if (set.has("terms_version")) rowAgreeGate.classList.add("errRow");
    if (set.has("consent")) rowConsent.classList.add("errRow");
  }

  function updateRegisterButtons(){
    const filled =
      f.sei.value.trim() &&
      f.mei.value.trim() &&
      f.seiKana.value.trim() &&
      f.meiKana.value.trim() &&
      f.phone.value.trim() &&
      f.address.value.trim();
    btnRegSubmit.disabled = !(filled && f.consent.checked);
    btnRegCancel.disabled = false;
  }

  function openTerms(){
    termsOpenedOnce = true;
    termsText.textContent = TERMS_TEXT;
    termsBox.scrollTop = 0;
    btnAcknowledge.disabled = true;
    modalBadge.textContent = "最後までスクロールしてください";
    termsHint.textContent = "最後までスクロールすると同意チェックが有効になります。";
    showOverlay(true);
  }

  function closeTerms(){
    showOverlay(false);
  }

  termsBox.addEventListener("scroll", () => {
    const nearBottom = (termsBox.scrollTop + termsBox.clientHeight) >= (termsBox.scrollHeight - 8);
    if (nearBottom) {
      termsScrolledToBottom = true;
      btnAcknowledge.disabled = false;
      modalBadge.textContent = "確認できます";
      termsHint.textContent = "確認しました を押すと同意チェックが有効になります。";
    }
  });

  btnAcknowledge.addEventListener("click", () => {
    if (!(termsOpenedOnce && termsScrolledToBottom)) return;
    f.agreeGate.disabled = false;
    f.agreeGate.checked = true;
    f.consent.disabled = false;
    updateRegisterButtons();
    closeTerms();
    clearErrors();
  });

  btnCloseTerms.addEventListener("click", closeTerms);
  document.getElementById("openTerms").addEventListener("click", openTerms);
  document.getElementById("openTerms").addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openTerms(); }
  });

  f.consent.addEventListener("change", updateRegisterButtons);
  Object.values(f).forEach(el => {
    if (el && (el.tagName === "INPUT" || el.tagName === "TEXTAREA")) {
      el.addEventListener("input", () => { updateRegisterButtons(); clearErrors(); });
    }
  });

  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      window[cb] = (data) => { cleanup(); resolve(data); };

      const script = document.createElement("script");
      const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, 20000);

      function cleanup(){
        clearTimeout(timer);
        if (script.parentNode) script.parentNode.removeChild(script);
        delete window[cb];
      }

      const sep = url.includes("?") ? "&" : "?";
      script.src = url + sep + "callback=" + encodeURIComponent(cb) + "&t=" + Date.now();
      script.onerror = () => { cleanup(); reject(new Error("loaderror")); };

      document.body.appendChild(script);
    });
  }

  async function profileStatus(){
    const idToken = liff.getIDToken();
    if (!idToken) return { ok:false, code:"NO_IDTOKEN" };
    const url = GAS_EXEC_URL + "?action=profile_status&id_token=" + encodeURIComponent(idToken);
    return await jsonp(url);
  }

  async function gate(){
    btnIn.disabled = true;
    btnOut.disabled = true;
    btnRegSubmit.disabled = true;
    btnRegCancel.disabled = true;

    const idToken = liff.getIDToken();
    if (!idToken){
      elBadge.textContent = "エラー";
      setDot("error");
      setStatus(
        "認証情報を取得できませんでした。LINEを開き直してお試しください。",
        "Could not get authentication info. Please reopen LINE and try again.",
        "无法获取认证信息。请重新打开LINE后重试。",
        "인증 정보를 가져올 수 없습니다. LINE을 다시 열고 시도해 주세요."
      );
      showRegister();
      btnRegCancel.disabled = false;
      return;
    }

    const st = await profileStatus();
    if (st && st.ok && st.has_profile){
      elBadge.textContent = "準備OK";
      setDot("ok");
      setStatus(
        "準備ができました。入店または退店を押してください。",
        "Ready. Tap Check in or Check out.",
        "准备就绪。请选择进入或离开。",
        "준비 완료. 입장 또는 퇴장을 눌러 주세요."
      );
      showActions();
      btnIn.disabled = false;
      btnOut.disabled = false;
      return;
    }

    elBadge.textContent = "登録が必要です";
    setDot("busy");
    setStatus(
      "初回のみ、会員情報の登録が必要です。利用規約を確認して登録してください。",
      "Registration is required for first-time use.",
      "首次需要登记。请确认条款后完成注册。",
      "최초 1회 등록이 필요합니다. 약관 확인 후 등록해 주세요."
    );
    showRegister();
    btnRegCancel.disabled = false;
    updateRegisterButtons();
  }

  btnRegCancel.addEventListener("click", () => {
    setDot("error");
    elBadge.textContent = "未登録";
    setStatus(
      "会員情報の登録が完了していないため、入店退店はできません。",
      "You can't proceed without registration.",
      "未完成登记，无法继续。",
      "등록이 완료되지 않아 진행할 수 없습니다."
    );
  });

  function clientValidate(){
    clearErrors();

    const missing = [];
    if (!f.sei.value.trim()) missing.push("sei");
    if (!f.mei.value.trim()) missing.push("mei");
    if (!f.seiKana.value.trim()) missing.push("sei_kana");
    if (!f.meiKana.value.trim()) missing.push("mei_kana");
    if (!f.phone.value.trim()) missing.push("phone");
    if (!f.address.value.trim()) missing.push("address");
    if (!(termsOpenedOnce && termsScrolledToBottom)) missing.push("terms_version");
    if (!f.consent.checked) missing.push("consent");

    if (missing.length){
      markMissing(missing);
      return { ok:false, missing };
    }
    return { ok:true, missing:[] };
  }

  btnRegSubmit.addEventListener("click", async () => {
    const v = clientValidate();
    if (!v.ok){
      elBadge.textContent = "エラー";
      setDot("error");
      setStatus(
        "未入力の項目があります。すべて入力し、同意にチェックしてください。",
        "Please complete all required fields and consent.",
        "请填写所有必填项并勾选同意。",
        "필수 항목을 모두 입력하고 동의에 체크해 주세요."
      );
      return;
    }

    const idToken = liff.getIDToken();
    if (!idToken) { await gate(); return; }

    setBusy(true);
    elBadge.textContent = "送信中";
    setDot("busy");
    setStatus("送信中です。しばらくお待ちください。","Sending...","发送中...","전송 중...");

    try{
      const url =
        GAS_EXEC_URL +
        "?action=profile_set" +
        "&id_token=" + encodeURIComponent(idToken) +
        "&sei=" + encodeURIComponent(f.sei.value.trim()) +
        "&mei=" + encodeURIComponent(f.mei.value.trim()) +
        "&sei_kana=" + encodeURIComponent(f.seiKana.value.trim()) +
        "&mei_kana=" + encodeURIComponent(f.meiKana.value.trim()) +
        "&phone=" + encodeURIComponent(f.phone.value.trim()) +
        "&address=" + encodeURIComponent(f.address.value.trim()) +
        "&consent=" + encodeURIComponent("true") +
        "&terms_version=" + encodeURIComponent(TERMS_VERSION) +
        "&ua=" + encodeURIComponent(navigator.userAgent || "");

      const res = await jsonp(url);

      if (res && res.ok){
        elBadge.textContent = "完了";
        setDot("ok");
        setStatus(
          "登録が完了しました。入店または退店を押してください。",
          "Registration completed.",
          "登记完成。",
          "등록 완료."
        );
        clearErrors();
        await gate();
      } else {
        elBadge.textContent = "エラー";
        setDot("error");
        if (res && res.code === "MISSING_FIELDS" && Array.isArray(res.missing)) {
          markMissing(res.missing);
        }
        setStatus(
          (res && res.message) ? res.message : "登録に失敗しました。",
          "Registration failed.",
          "登记失败。",
          "등록 실패."
        );
      }
    } catch(e){
      elBadge.textContent = "エラー";
      setDot("error");
      setStatus(
        "通信エラーまたはタイムアウトです。電波状況を確認してお試しください。",
        "Network error or timeout.",
        "通信错误或超时。",
        "통신 오류 또는 시간 초과."
      );
    } finally {
      setBusy(false);
    }
  });

  async function callAction(action){
    const idToken = liff.getIDToken();
    if (!idToken) { await gate(); return; }

    setBusy(true);
    elBadge.textContent = "処理中";
    setDot("busy");
    setStatus("通信中です。しばらくお待ちください。","Communicating...","正在通信...","통신 중...");

    try{
      const url = GAS_EXEC_URL + "?action=" + encodeURIComponent(action) + "&id_token=" + encodeURIComponent(idToken);
      const res = await jsonp(url);
      if (res && res.ok){
        elBadge.textContent = "完了";
        setDot("ok");
        setStatus(
          res.message || "完了しました。",
          "Done.",
          "完成。",
          "완료."
        );
      } else if (res && res.code === "DENY_NEED_PROFILE") {
        await gate();
      } else {
        elBadge.textContent = "エラー";
        setDot("error");
        setStatus(
          (res && res.message) ? res.message : "エラーが発生しました。",
          "Error.",
          "错误。",
          "오류."
        );
      }
    } catch(e){
      elBadge.textContent = "エラー";
      setDot("error");
      setStatus(
        "通信エラーまたはタイムアウトです。電波状況を確認してお試しください。",
        "Network error or timeout.",
        "通信错误或超时。",
        "통신 오류 또는 시간 초과."
      );
    } finally {
      setBusy(false);
    }
  }

  btnIn.addEventListener("click", () => callAction("in"));
  btnOut.addEventListener("click", () => callAction("out"));

  async function init(){
    elBadge.textContent = "起動中";
    setDot("busy");
    setStatus("初期化中...","Initializing...","正在初始化...","초기화 중...");
    try{
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
      await gate();
    } catch(e){
      elBadge.textContent = "エラー";
      setDot("error");
      setStatus(
        "初期化に失敗しました。通信環境と設定を確認してください。",
        "Initialization failed. Check network and settings.",
        "初始化失败。请检查网络和设置。",
        "초기화에 실패했습니다. 네트워크와 설정을 확인해 주세요."
      );
    }
  }

  init();
</script>
</body>
</html>
