<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>COMPASSION WORLD 入店退店管理システム</title>

<style>
:root{
  --bg:#0b0f1a; --card:#121a2b; --text:#e7ecff; --muted:#aab6da;
  --ok:#1db954; --warn:#f4c542; --err:#ff5a6a;
  --line:rgba(255,255,255,.15); --radius:16px;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:system-ui,"Noto Sans JP",sans-serif;
  background:var(--bg); color:var(--text);
  min-height:100vh; display:flex; justify-content:center; align-items:center;
}
.app{width:min(720px,100%); padding:16px}
.card{
  background:var(--card); border-radius:var(--radius);
  padding:20px; border:1px solid var(--line);
}
h1{font-size:16px;margin:0 0 12px}
.status{font-size:14px;margin-bottom:16px}
.hidden{display:none}

label{font-size:12px;color:var(--muted)}
input,textarea{
  width:100%; padding:10px; border-radius:12px;
  border:1px solid var(--line); background:#0003; color:var(--text)
}
textarea{min-height:80px}
.field{margin-bottom:10px}
.field.error input,.field.error textarea{
  border-color:var(--err); box-shadow:0 0 0 2px #ff5a6a44
}

.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

button{
  width:100%; padding:14px; border-radius:14px;
  border:1px solid var(--line); background:#fff1; color:var(--text);
  cursor:pointer; font-size:14px
}
button.primary{background:#1db95433;border-color:#1db954}
button:disabled{opacity:.5;cursor:not-allowed}

.checkRow{
  border:1px solid var(--line); padding:10px; border-radius:12px;
  display:flex; gap:8px; font-size:12px; margin-top:10px
}
.checkRow.error{border-color:var(--err)}
.checkRow input{margin-top:2px}

.actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}

.overlay{
  position:fixed; inset:0; background:#0008;
  display:none; justify-content:center; align-items:center; padding:16px
}
.overlay.show{display:flex}
.modal{
  background:var(--card); padding:16px; border-radius:16px;
  max-height:80vh; overflow:auto; border:1px solid var(--line)
}
.modal h2{font-size:14px;margin-top:0}
</style>
</head>

<body>
<div class="app">
  <div class="card">
    <h1>COMPASSION WORLD 入店退店管理システム</h1>
    <div id="status" class="status">初期化中…</div>

    <!-- 会員登録 -->
    <div id="reg">
      <p style="font-size:13px;line-height:1.7">
COMPASSION WORLDが<br>
平和で心地よい世界であり続けるために<br><br>
初めてご利用いただく際のみ、会員登録へのご協力をお願いしています。
      </p>

      <div class="row2">
        <div class="field" id="w_ln"><label>姓</label><input id="ln"></div>
        <div class="field" id="w_fn"><label>名</label><input id="fn"></div>
      </div>

      <div class="row2">
        <div class="field" id="w_lk"><label>セイ</label><input id="lk"></div>
        <div class="field" id="w_fk"><label>メイ</label><input id="fk"></div>
      </div>

      <div class="row2">
        <div class="field" id="w_dob"><label>生年月日</label><input id="dob" type="date"></div>
        <div class="field" id="w_ph"><label>電話番号</label><input id="ph"></div>
      </div>

      <div class="field" id="w_ad"><label>住所</label><textarea id="ad"></textarea></div>

      <div class="checkRow" id="termsRow">
        <input type="checkbox" id="agree" disabled>
        <div>
          本システムが COMPASSION WORLD の平和な世界を守るために利用されることに同意します<br>
          <span id="openTerms" style="text-decoration:underline;cursor:pointer">利用規約を表示</span>
        </div>
      </div>

      <div class="actions">
        <button id="send" class="primary" disabled>登録を送信</button>
        <button id="clear">クリア</button>
      </div>
    </div>

    <!-- 入退店 -->
    <div id="io" class="hidden">
      <div class="actions">
        <button id="in" class="primary">入店</button>
        <button id="out">退店</button>
      </div>
    </div>
  </div>
</div>

<!-- 規約 -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h2>利用規約</h2>
    <pre style="white-space:pre-wrap;font-size:12px;line-height:1.7">
第1条 目的
本規約は、COMPASSION WORLD 入店退店管理システムを利用するすべての利用者に対し、施設の安全な運営、緊急時の連絡を目的として、会員情報の取得および利用条件を定めるものです。

第2条 会員登録
本システムを利用して入店または退店を行う場合、初回利用時に以下の会員情報の登録が必要となります。
・姓
・名
・姓（カナ）
・名（カナ）
・生年月日      
・住所
・電話番号
利用者は、正確かつ最新の情報を登録するものとします。

第3条 個人情報の利用目的
取得した個人情報は、以下の目的の範囲内で利用します。
・施設の入退店履歴の管理
・緊急時における利用者への連絡
・安心して過ごせる環境づくりのための確認
・法令に基づく対応および手続

第4条 店内備品等の破損・汚損
利用者の故意または過失、または通常の使用方法を超える利用により、店内備品、設備、商品、建物その他の物品に破損、汚損、紛失等の損害が生じた場合、当施設は、修理または交換に要する合理的な実費相当額を請求できるものとし、利用者はこれを負担します。
通常の利用による経年劣化、通常損耗に該当するものは、原則として請求の対象外とします。

第5条 個人情報の管理
取得した個人情報は、漏えい、紛失、改ざん等を防止するため、適切な安全管理措置を講じて管理します。

第6条 個人情報の第三者提供
以下の場合を除き、本人の同意なく第三者に提供することはありません。
・法令に基づく場合
・警察、裁判所等の公的機関から正当な要請を受けた場合
・利用者または第三者の生命、身体、財産の保護のために必要な場合

第7条 入店退店の制限
会員登録が完了していない場合、または虚偽の情報が登録されていると判断された場合、本システムによる入店および退店をお断りすることがあります。

第8条 規約の変更
本規約は、必要に応じて予告なく変更されることがあります。変更後の規約は、本システム上に表示された時点で効力を生じます。

第9条 同意の成立
本規約は、利用者が規約内容を確認し、同意の意思表示を行ったうえで会員登録を送信した時点で成立するものとします。

    </pre>
    <button id="okTerms" class="primary">確認しました</button>
  </div>
</div>

<script>
const GAS = "https://script.google.com/macros/s/AKfycbw7kdVIexHvoXqW_abWxBxUZgP13k4Zkt5DnVXwih8wkpTc1xRZFALdjaa31JQVPvz6/exec";

const uid = (() => {
  let k = localStorage.getItem("cw_user_key");
  if(!k){ k="u_"+Math.random().toString(36).slice(2); localStorage.setItem("cw_user_key",k);}
  return k;
})();

function jsonp(url){
  return new Promise((res,rej)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    window[cb]=d=>{delete window[cb];s.remove();res(d)};
    const s=document.createElement("script");
    s.src=url+"&callback="+cb;
    s.onerror=()=>rej();
    document.body.appendChild(s);
  });
}

async function init(){
  const r=await jsonp(`${GAS}?action=profile_status&user_key=${uid}`);
  if(r.ok && r.has_profile){
    reg.classList.add("hidden"); io.classList.remove("hidden");
    status.textContent="準備完了";
  }else{
    status.textContent="会員登録をお願いします";
  }
}

send.onclick=async()=>{
  const data={
    ln:ln.value, fn:fn.value, lk:lk.value, fk:fk.value,
    dob:dob.value, ph:ph.value, ad:ad.value, agree:agree.checked
  };
  const miss=[];
  [["ln","w_ln"],["fn","w_fn"],["lk","w_lk"],["fk","w_fk"],["dob","w_dob"],["ph","w_ph"],["ad","w_ad"]]
    .forEach(([k,w])=>{document.getElementById(w).classList.toggle("error",!data[k]); if(!data[k])miss.push(k)});
  termsRow.classList.toggle("error",!data.agree);
  if(miss.length||!data.agree)return;

  status.textContent="登録中…";
  const q=new URLSearchParams({
    action:"profile_set", user_key:uid,
    last_name:data.ln, first_name:data.fn,
    last_kana:data.lk, first_kana:data.fk,
    dob:data.dob, phone:data.ph, address:data.ad,
    consent:"true"
  });
  const r=await jsonp(`${GAS}?${q}`);
  if(r.ok){ reg.classList.add("hidden"); io.classList.remove("hidden"); status.textContent="登録完了"; }
};

in.onclick=()=>jsonp(`${GAS}?action=check_in&user_key=${uid}`).then(r=>status.textContent=r.message);
out.onclick=()=>jsonp(`${GAS}?action=check_out&user_key=${uid}`).then(r=>status.textContent=r.message);

openTerms.onclick=()=>overlay.classList.add("show");
okTerms.onclick=()=>{
  overlay.classList.remove("show");
  agree.disabled=false; agree.checked=true; send.disabled=false;
};

clear.onclick=()=>location.reload();

init();
</script>
</body>
</html>
